<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<title>Spoty</title>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700;900&family=Noto+Sans+JP:wght@400;500;700;900&display=swap" rel="stylesheet">

<script src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&libraries=places"></script>

<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<style>
/* --- æ—¢å­˜ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ç¶­æŒã—ã¤ã¤ã€ä»¥ä¸‹ã®ä¿®æ­£ã‚’è¿½åŠ  --- */
:root{
  --bg:#060608;--s1:#0f0f14;--s2:#18181f;--s3:#22222c;
  --bd:rgba(255,255,255,0.08);--bd2:rgba(255,255,255,0.04);
  --a1:#a78bff;--a2:#ff5f8f;--a3:#00e5a0;--a4:#ffd060;
  --tx:#f2f2ff;--mu:#60607a;--mu2:#9898b8;
  --gr:linear-gradient(135deg,#a78bff,#ff5f8f);
}

/* ä¿®æ­£ï¼šè©³ç´°ãŒæŠ¼ã›ãªã„å•é¡Œã®å¯¾ç­– */
.vpost-info {
  position: absolute; bottom: 0; left: 0; right: 60px; z-index: 10;
  padding: 0 14px 110px;
  pointer-events: none; /* ã“ã‚Œã§ä¸‹ã®è¦ç´ ã®ã‚¯ãƒªãƒƒã‚¯ã‚’é‚ªé­”ã—ãªã„ */
}
.vpost-info * {
  pointer-events: auto; /* ä¸­ã®ãƒ†ã‚­ã‚¹ãƒˆã‚„ãƒœã‚¿ãƒ³ã¯æŠ¼ã›ã‚‹ã‚ˆã†ã«ã™ã‚‹ */
}

/* ä¿®æ­£ï¼šãƒ­ã‚°ã‚¤ãƒ³ãŒæŠ¼ã›ãªã„å•é¡Œã®å¯¾ç­– */
#authWrap {
  z-index: 2000; /* ã‚¢ãƒ—ãƒªå…¨ä½“ã‚ˆã‚Šä¸Šã«é…ç½® */
}
.auth-card {
  position: relative; z-index: 2001;
}

/* ä¿®æ­£ï¼šGoogle Mapç”¨ */
#mapWrap {
  width: 100%; height: 100%;
}

/* ä¿®æ­£ï¼šãƒˆãƒ¼ã‚¹ãƒˆè¡¨ç¤ºç”¨ */
.toast {
  position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%) translateY(20px);
  background: var(--s2); border: 1px solid var(--a1); color: #fff;
  padding: 12px 24px; border-radius: 12px; z-index: 5000;
  opacity: 0; pointer-events: none; transition: 0.3s;
}
.toast.on { opacity: 1; transform: translateX(-50%) translateY(0); }

/* --- ãã®ä»–ã€é€ã£ã¦ã„ãŸã ã„ãŸCSSãŒã“ã“ã«ç¶šãã¾ã™ --- */
</style>
</head>
<script src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&libraries=places"></script>

<style>
/* â”€â”€ ä¸å…·åˆä¿®æ­£ï¼šè©³ç´°ãŒæŠ¼ã›ãªã„å•é¡Œ â”€â”€ */
.vpost-info {
    position: absolute; bottom: 0; left: 0; right: 60px; z-index: 10;
    padding: 0 14px 110px;
    pointer-events: none; /* ä¸‹ã®è¦ç´ ã®ã‚¯ãƒªãƒƒã‚¯ã‚’é‚ªé­”ã—ãªã„ */
}
.vpost-info * {
    pointer-events: auto; /* infoå†…ã®æ–‡å­—ã‚„ãƒœã‚¿ãƒ³ã¯ã‚¯ãƒªãƒƒã‚¯å¯èƒ½ã«ã™ã‚‹ */
}

/* â”€â”€ ä¸å…·åˆä¿®æ­£ï¼šãƒ­ã‚°ã‚¤ãƒ³ãŒæŠ¼ã›ãªã„å•é¡Œ â”€â”€ */
#authWrap {
    z-index: 9999; /* ç¢ºå®Ÿã«æœ€å‰é¢ã«æŒã£ã¦ãã‚‹ */
}

/* â”€â”€ Google Mapç”¨ â”€â”€ */
#theMap {
    width: 100%;
    height: 100%;
}

/* ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ï¼ˆåœ§ç¸®ä¸­ãªã©ã®é€²æ—è¡¨ç¤ºç”¨ï¼‰ */
.toast {
    position: fixed; bottom: 85px; left: 50%; transform: translateX(-50%) translateY(20px);
    background: rgba(0,0,0,0.85); border: 1px solid var(--a1); color: #fff;
    padding: 12px 20px; border-radius: 12px; z-index: 10000;
    opacity: 0; pointer-events: none; transition: 0.3s;
}
.toast.on { opacity: 1; transform: translateX(-50%) translateY(0); }
</style>

<div id="toast" class="toast"></div>

<script>
// --- ç”»åƒåœ§ç¸®ãƒ­ã‚¸ãƒƒã‚¯ (æºå¸¯ã®é‡ã„å†™çœŸã‚’1/10ä»¥ä¸‹ã«ã™ã‚‹) ---
async function compressImage(file) {
    return new Promise((resolve) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = (e) => {
            const img = new Image();
            img.src = e.target.result;
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const MAX_WIDTH = 1080; // é«˜ç”»è³ªã‚’ä¿ã¡ã¤ã¤ãƒªã‚µã‚¤ã‚º
                let width = img.width;
                let height = img.height;

                if (width > MAX_WIDTH) {
                    height = (MAX_WIDTH / width) * height;
                    width = MAX_WIDTH;
                }
                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);
                // ç”»è³ª0.7ï¼ˆ70%ï¼‰ã§JPEGå¤‰æ›
                resolve(canvas.toDataURL('image/jpeg', 0.7));
            };
        };
    });
}

// --- ä¿®æ­£ç‰ˆï¼šç”»åƒé¸æŠæ™‚ã®å‡¦ç† ---
let tempPhotos = []; // åœ§ç¸®æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ã‚’ä¸€æ™‚ä¿å­˜

async function handlePicFile(event) {
    const file = event.target.files[0];
    if (!file) return;

    if (tempPhotos.length >= 8) {
        showToast("æœ€å¤§8æšã¾ã§ã§ã™");
        return;
    }

    showToast("ç”»åƒã‚’æœ€é©åŒ–ä¸­...");
    const compressedData = await compressImage(file);
    tempPhotos.push(compressedData);
    
    renderPhotoSlots(); // ã‚¹ãƒ­ãƒƒãƒˆã‚’å†æç”»
}

// --- Google Map åˆæœŸåŒ– ---
let googleMap;
function initGoogleMap() {
    const defaultPos = { lat: 35.6812, lng: 139.7671 }; // æ±äº¬
    googleMap = new google.maps.Map(document.getElementById("theMap"), {
        center: defaultPos,
        zoom: 13,
        styles: [
            { "elementType": "geometry", "stylers": [{ "color": "#1d2c4d" }] },
            { "elementType": "labels.text.fill", "stylers": [{ "color": "#8ec3b9" }] },
            // å¿…è¦ã«å¿œã˜ã¦ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ã“ã“ã«è¿½åŠ 
        ]
    });
}

// ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸæ™‚ã«ãƒãƒƒãƒ—ã‚’ãƒ­ãƒ¼ãƒ‰
function doLogin() {
    // æ—¢å­˜ã®ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†...
    document.getElementById('authWrap').style.display = 'none';
    document.getElementById('app').style.display = 'flex';
    initGoogleMap(); // ã“ã“ã§Google Mapã‚’èµ·å‹•
    loadFeed();
}

// ãƒˆãƒ¼ã‚¹ãƒˆè¡¨ç¤ºé–¢æ•°
function showToast(msg) {
    const t = document.getElementById('toast');
    t.innerText = msg;
    t.classList.add('on');
    setTimeout(() => t.classList.remove('on'), 3000);
}

// --- ä¿®æ­£ç‰ˆï¼šè©³ç´°è¡¨ç¤º (pointer-eventsã®å½±éŸ¿ã‚’å—ã‘ãªã„ã‚ˆã†ã«) ---
function openDetail(postId) {
    // Firestoreã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–ã£ã¦ãã¦è¡¨ç¤ºã™ã‚‹æ—¢å­˜ã®å‡¦ç†
    console.log("è©³ç´°ã‚’é–‹ã:", postId);
    document.getElementById('detailOv').classList.add('on');
    // ...è©³ç´°æç”»ãƒ­ã‚¸ãƒƒã‚¯...
}
</script>
/* â•â• ğŸ› ï¸ è¿½åŠ ï¼šç”»åƒåœ§ç¸®ã¨FirestoreæŠ•ç¨¿ã®ã‚³ã‚¢ãƒ­ã‚¸ãƒƒã‚¯ â•â• */

// æºå¸¯ã®é‡ã„ç”»åƒã‚’æŠ•ç¨¿å‰ã«1/10ä»¥ä¸‹ã«è»½é‡åŒ–ã™ã‚‹
async function compressImage(file) {
  return new Promise((resolve) => {
    const reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onload = (e) => {
      const img = new Image();
      img.src = e.target.result;
      img.onload = () => {
        const canvas = document.createElement('canvas');
        const MAX_WIDTH = 1080; // ãƒ¢ãƒã‚¤ãƒ«å‘ã‘æœ€é©ã‚µã‚¤ã‚º
        let width = img.width;
        let height = img.height;

        if (width > MAX_WIDTH) {
          height = (MAX_WIDTH / width) * height;
          width = MAX_WIDTH;
        }
        canvas.width = width;
        canvas.height = height;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, width, height);
        // ç”»è³ªã‚’70%ã«è½ã¨ã—ã¦å®¹é‡ã‚’åŠ‡çš„ã«å‰Šæ¸›
        resolve(canvas.toDataURL('image/jpeg', 0.7));
      };
    };
  });
}

// æŠ•ç¨¿ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸæ™‚ã®å‡¦ç†
async function submitPost() {
  if (!cu) return toast("ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™");
  const title = document.getElementById('pTitle').value.trim();
  const pref = document.getElementById('pPref').value.trim();
  const desc = document.getElementById('pDsc').value.trim();
  
  if (!title || !pref || !desc || selPhotos.length === 0) {
    return toast("å¿…é ˆé …ç›®ï¼ˆå†™çœŸãƒ»ã‚¹ãƒãƒƒãƒˆåãƒ»åœ°åŸŸãƒ»è©³ç´°ï¼‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
  }

  toast("â³ æŠ•ç¨¿ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...");
  
  const cats = Array.from(document.querySelectorAll('.catChk:checked')).map(c => c.value);
  
  const newPost = {
    title,
    pref,
    cat: cats[0] || "ãã®ä»–",
    tags: document.getElementById('pTgs').value.split(/[\sã€€]+/).filter(Boolean),
    desc,
    year: document.getElementById('pYr').value,
    month: document.getElementById('pMo').value,
    time: document.getElementById('pTm').value,
    crowd: document.getElementById('pCr').value,
    rating: document.getElementById('pRt').value,
    orient: selOrient,
    music: selMusic,
    photos: selPhotos, // ã™ã§ã«åœ§ç¸®æ¸ˆã¿ã®Base64é…åˆ—
    uid: cu.uid,
    uName: cu.name,
    uAv: cu.av,
    likes: 0,
    likedBy: [],
    savedBy: [],
    comments: [],
    badges: {
      local: document.getElementById('bLo').checked,
      hidden: document.getElementById('bHi').checked,
      photo: document.getElementById('bPh').checked
    },
    createdAt: Date.now()
  };

  try {
    await window.db.collection("posts").add(newPost);
    toast("âœ… æŠ•ç¨¿ãŒå®Œäº†ã—ã¾ã—ãŸï¼");
    closeOv('postOv');
    clearPostForm();
    switchSc('feed');
  } catch (e) {
    console.error(e);
    toast("âŒ æŠ•ç¨¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚å®¹é‡åˆ¶é™ã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚");
  }
}

// æŠ•ç¨¿ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
function clearPostForm() {
  document.getElementById('pTitle').value = '';
  document.getElementById('pDsc').value = '';
  selPhotos = [];
  selMusic = null;
  initPhotoSlots();
  document.querySelectorAll('.catChk, #bLo, #bHi, #bPh').forEach(c => c.checked = false);
}

/* â•â• ğŸ› ï¸ ä¿®æ­£ï¼šã„ã„ã­æ©Ÿèƒ½ï¼ˆFirestoreé€£æºã®å¼·åŒ–ï¼‰ â•â• */
async function toggleLike(id, reVert = false) {
  if (!cu) return toast('ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™');

  // Firestoreã‹ã‚‰æœ€æ–°ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‚ç…§
  const postRef = window.db.collection("posts").doc(id);
  const doc = await postRef.get();
  if (!doc.exists) return;

  let data = doc.data();
  let likedBy = data.likedBy || [];
  let likes = data.likes || 0;
  const idx = likedBy.indexOf(cu.uid);

  if (idx >= 0) {
    likedBy.splice(idx, 1);
    likes = Math.max(0, likes - 1);
    toast('ğŸ¤ ã„ã„ã­ã‚’å–ã‚Šæ¶ˆã—ã¾ã—ãŸ');
  } else {
    likedBy.push(cu.uid);
    likes += 1;
    toast('â¤ï¸ ã„ã„ã­ï¼ã—ã¾ã—ãŸ');
  }

  await postRef.update({ likes, likedBy });
  // reVertãŒtrueã®å ´åˆã¯ç¸¦ãƒ•ã‚£ãƒ¼ãƒ‰ã‚’å†æç”»
  if (reVert) renderVert();
}

/* â•â• ğŸ› ï¸ ä¿®æ­£ï¼šè©³ç´°ç”»é¢ã®HTML â•â• */
// ï¼ˆè©³ç´°ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸæ™‚ã® z-index ã‚„ pointer-events ã®å¹²æ¸‰ã‚’å›é¿ã™ã‚‹ãŸã‚ï¼‰
function openDetail(id) {
  const p = posts.find(x => x.id === id);
  if (!p) return;

  // è©³ç´°ç”»é¢ã‚’é–‹ãéš›ã«ã€èƒŒå¾Œã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’æ­¢ã‚ã‚‹
  document.body.style.overflow = 'hidden';
  
  // æ—¢å­˜ã® detailInner ã¸ã®æ›¸ãè¾¼ã¿å‡¦ç†...
  // ï¼ˆæä¾›ã•ã‚ŒãŸ openDetail ã®ã‚³ãƒ¼ãƒ‰ã‚’ãã®ã¾ã¾ä½¿ç”¨ã—ã¦OKã§ã™ãŒã€
  // æœ€å¾Œã«ä»¥ä¸‹ã®1è¡Œã‚’ç¢ºå®Ÿã«å®Ÿè¡Œã—ã¦ãã ã•ã„ï¼‰
  document.getElementById('detailOv').classList.add('on');
}

function closeOv(id) {
  document.getElementById(id).classList.remove('on');
  document.body.style.overflow = ''; // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å†é–‹
}
  /* â•â• ğŸ› ï¸ ä¿®æ­£ï¼šãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»åƒã¨ãƒ‡ãƒ¼ã‚¿ã®æ›´æ–° â•â• */
async function handleAv(e) {
  const f = e.target.files[0];
  if (!f) return;

  // å‰è¿°ã®compressImageé–¢æ•°ãŒã‚ã‚Œã°ãã‚Œã‚’åˆ©ç”¨ã€ãªã‘ã‚Œã°ç°¡æ˜“FileReader
  const r = new FileReader();
  r.onload = async (ev) => {
    const avData = ev.target.result;
    
    // 1. ãƒ­ãƒ¼ã‚«ãƒ«çŠ¶æ…‹ã‚’æ›´æ–°
    users[cu.email].av = avData;
    cu.av = avData;
    
    // 2. ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ä¿å­˜
    sv('users', users);
    
    // 3. (ã‚ªãƒ—ã‚·ãƒ§ãƒ³) Firestoreã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’ä¿å­˜ã—ã¦ã„ã‚‹å ´åˆã¯ã“ã“ã«è¿½åŠ 
    // await window.db.collection("users").doc(cu.uid).update({ av: avData });

    updTopAv();
    renderMypage();
    toast('ğŸ“· ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å†™çœŸã‚’æ›´æ–°ã—ã¾ã—ãŸï¼');
  };
  r.readAsDataURL(f);
}

/* â•â• ğŸ› ï¸ ä¿®æ­£ï¼šæŠ•ç¨¿ã®å‰Šé™¤ï¼ˆFirestoreå®Œå…¨é€£å‹•ï¼‰ â•â• */
async function delPost(id) {
  if (!confirm('ã“ã®æŠ•ç¨¿ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) return;

  try {
    await window.db.collection("posts").doc(id).delete();
    // å‰Šé™¤æˆåŠŸæ™‚ã€postsé…åˆ—ã‹ã‚‰ã‚‚å‰Šé™¤ï¼ˆonSnapshotãŒå‹•ãã¾ã§ã®ãƒ©ã‚°å¯¾ç­–ï¼‰
    posts = posts.filter(p => p.id !== id);
    
    toast('ğŸ—‘ï¸ æŠ•ç¨¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
    
    // è¡¨ç¤ºã‚’ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥
    if (curSc === 'mypage') renderMypage();
    if (feedMode === 'vert') renderVert(); else renderGrid();
  } catch (e) {
    console.error("Delete error:", e);
    toast('âŒ å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
  }
}

/* â•â• ğŸ› ï¸ ä¿®æ­£ï¼šãƒãƒƒãƒ—ã®ãƒ”ãƒ³è¡¨ç¤ºã¨åˆæœŸåŒ– â•â• */
function initMap() {
  const mc = document.getElementById('theMap');
  if (!mc) return;
  
  // ãƒ¢ãƒã‚¤ãƒ«ç”»é¢ã®é«˜ã•ã«åˆã‚ã›ã¦èª¿æ•´
  mc.style.height = (window.innerHeight - 120) + 'px';

  if (!mapInst) {
    // æ—¥æœ¬å…¨ä½“ãŒè¦‹ãˆã‚‹ä½ç½®ã«åˆæœŸåŒ–
    mapInst = L.map('theMap', { zoomControl: false }).setView([36.2048, 138.2529], 5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Â© OpenStreetMap'
    }).addTo(mapInst);
    
    // ã‚ºãƒ¼ãƒ ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚’å³ä¸‹ã«é…ç½®ï¼ˆãƒ¢ãƒã‚¤ãƒ«UIå¯¾ç­–ï¼‰
    L.control.zoom({ position: 'bottomright' }).addTo(mapInst);
  }
  
  renderMapPins();
  // åœ°å›³ã®è¡¨ç¤ºå´©ã‚Œã‚’é˜²ããŸã‚ã®å¼·åˆ¶ãƒªã‚µã‚¤ã‚º
  setTimeout(() => mapInst.invalidateSize(), 300);
}

function renderMapPins() {
  if (!mapInst) return;
  mapMkrs.forEach(m => m.remove());
  mapMkrs = [];

  const list = posts.filter(p => p.lat && p.lng);
  
  list.forEach(p => {
    const isSv = cu && (p.savedBy || []).includes(cu.uid);
    // ãƒ”ãƒ³ã®è¦‹ãŸç›®ã‚’ã‚ˆã‚Šãƒ¢ãƒ€ãƒ³ã«
    const icon = L.divIcon({
      className: 'custom-pin',
      html: `<div style="
        background: ${isSv ? 'var(--a3)' : 'var(--gr)'};
        color: white;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: bold;
        white-space: nowrap;
        box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        border: 1.5px solid #fff;
      ">${isSv ? 'ğŸ”– ' : ''}${p.title}</div>`,
      iconAnchor: [20, 0]
    });

    const mk = L.marker([p.lat, p.lng], { icon }).addTo(mapInst);
    
    // ã‚¯ãƒªãƒƒã‚¯ã§è©³ç´°ã‚’è¡¨ç¤º
    mk.on('click', () => {
      openDetail(p.id);
    });
    
    mapMkrs.push(mk);
  });
}
  
