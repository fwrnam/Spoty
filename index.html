
Spoty Â· HTML
ã‚³ãƒ”ãƒ¼

<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<title>Spoty</title>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700;900&family=Noto+Sans+JP:wght@400;500;700;900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
:root{
  --bg:#060608;--s1:#0f0f14;--s2:#18181f;--s3:#22222c;
  --bd:rgba(255,255,255,0.08);--bd2:rgba(255,255,255,0.04);
  --a1:#a78bff;--a2:#ff5f8f;--a3:#00e5a0;--a4:#ffd060;
  --tx:#f2f2ff;--mu:#60607a;--mu2:#9898b8;
  --gr:linear-gradient(135deg,#a78bff,#ff5f8f);
  --gr2:linear-gradient(135deg,#00e5a0,#00c8f5);
  --sh:0 20px 60px rgba(0,0,0,0.8);
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
html{height:100%;-webkit-text-size-adjust:100%;}
body{
  height:100%;background:var(--bg);color:var(--tx);
  font-family:'Noto Sans JP','Outfit',sans-serif;
  overflow:hidden;position:fixed;width:100%;
}
::-webkit-scrollbar{display:none;}
img{display:block;max-width:100%;}
button{cursor:pointer;font-family:inherit;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   AUTH
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#authWrap{
  position:fixed;inset:0;z-index:999;background:var(--bg);
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  padding:24px;overflow-y:auto;
}
.auth-logo-block{text-align:center;margin-bottom:40px;}
.auth-pin{font-size:4rem;animation:pinFloat 3s ease-in-out infinite;display:block;margin-bottom:8px;}
@keyframes pinFloat{0%,100%{transform:translateY(0) rotate(-5deg)}50%{transform:translateY(-12px) rotate(5deg)}}
.auth-wordmark{
  font-family:'Outfit',sans-serif;font-size:3.2rem;font-weight:900;letter-spacing:-0.05em;
  background:var(--gr);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;
}
.auth-tagline{font-size:0.82rem;color:var(--mu2);margin-top:6px;letter-spacing:0.06em;}
.auth-card{background:var(--s1);border:1px solid var(--bd);border-radius:28px;width:100%;max-width:420px;padding:30px 24px;}
.auth-segs{display:flex;background:var(--s2);border-radius:16px;padding:4px;margin-bottom:24px;gap:4px;}
.auth-seg{flex:1;padding:11px;border:none;background:none;font-family:inherit;font-size:0.88rem;font-weight:700;color:var(--mu);border-radius:12px;cursor:pointer;transition:all 0.22s;}
.auth-seg.on{background:var(--gr);color:#fff;}
.ae{display:none;background:rgba(255,95,143,0.1);border:1px solid rgba(255,95,143,0.3);border-radius:12px;padding:10px 14px;font-size:0.8rem;color:var(--a2);margin-bottom:12px;}
.fg{margin-bottom:14px;}
.fl{display:block;font-size:0.66rem;font-weight:700;color:var(--mu);letter-spacing:0.15em;text-transform:uppercase;margin-bottom:6px;}
.fi{width:100%;background:var(--s2);border:1px solid var(--bd);border-radius:13px;padding:13px 15px;color:var(--tx);font-family:inherit;font-size:0.9rem;outline:none;transition:border-color 0.2s;-webkit-appearance:none;}
.fi:focus{border-color:var(--a1);}
.fi::placeholder{color:var(--mu);}
.auth-btn{width:100%;background:var(--gr);border:none;border-radius:14px;padding:15px;font-family:inherit;font-size:0.95rem;font-weight:900;color:#fff;margin-top:6px;transition:transform 0.15s;}
.auth-btn:active{transform:scale(0.97);}
.demo-note{text-align:center;margin-top:14px;font-size:0.73rem;color:var(--mu);line-height:1.7;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   APP SHELL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#app{display:none;position:fixed;inset:0;flex-direction:column;}

/* TOP BAR */
.topbar{
  flex-shrink:0;height:52px;
  display:flex;align-items:center;padding:0 14px;gap:10px;
  background:linear-gradient(to bottom,rgba(6,6,8,0.95),rgba(6,6,8,0.0));
  position:absolute;top:0;left:0;right:0;z-index:200;
}
.tb-logo{font-family:'Outfit',sans-serif;font-size:1.4rem;font-weight:900;letter-spacing:-0.04em;background:var(--gr);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;cursor:pointer;flex-shrink:0;}
.tb-search{flex:1;display:flex;align-items:center;gap:6px;background:rgba(255,255,255,0.08);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,0.1);border-radius:20px;padding:0 12px;height:34px;}
.tb-search input{flex:1;background:none;border:none;outline:none;color:var(--tx);font-family:inherit;font-size:0.8rem;min-width:0;}
.tb-search input::placeholder{color:var(--mu2);}
.tb-search button{background:none;border:none;color:var(--a1);font-size:0.9rem;}
.tb-av{width:32px;height:32px;border-radius:50%;flex-shrink:0;overflow:hidden;background:var(--gr);display:flex;align-items:center;justify-content:center;font-size:0.82rem;font-weight:900;color:#fff;cursor:pointer;border:2px solid rgba(255,255,255,0.2);}
.tb-av img{width:100%;height:100%;object-fit:cover;}

/* SCREENS */
.screens{position:absolute;inset:0;overflow:hidden;}
.screen{position:absolute;inset:0;display:none;flex-direction:column;overflow:hidden;}
.screen.on{display:flex;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FEED SCREEN â€“ TikTok / IG style
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#feedScreen{background:var(--bg);}
.feed-mode-toggle{
  position:absolute;top:56px;right:14px;z-index:201;
  display:flex;background:rgba(0,0,0,0.55);backdrop-filter:blur(12px);
  border:1px solid rgba(255,255,255,0.1);border-radius:20px;overflow:hidden;
}
.fmt-btn{padding:6px 14px;border:none;background:none;color:var(--mu2);font-family:inherit;font-size:0.72rem;font-weight:700;cursor:pointer;transition:all 0.2s;}
.fmt-btn.on{background:rgba(255,255,255,0.15);color:#fff;}

/* FEED TAB BAR */
.feed-tabs{
  position:absolute;top:54px;left:0;right:0;z-index:201;
  display:flex;justify-content:center;gap:0;
  padding:4px 0;
}
.ftab{
  padding:7px 18px;border:none;background:none;
  font-family:inherit;font-size:0.85rem;font-weight:700;color:rgba(255,255,255,0.5);
  border-bottom:2px solid transparent;cursor:pointer;transition:all 0.2s;
}
.ftab.on{color:#fff;border-bottom-color:#fff;}

/* â”€â”€â”€ VERTICAL SCROLL FEED (TikTok mode) â”€â”€â”€ */
#vertFeed{
  position:absolute;inset:0;
  overflow-y:scroll;scroll-snap-type:y mandatory;
  -webkit-overflow-scrolling:touch;
  scrollbar-width:none;
}
#vertFeed::-webkit-scrollbar{display:none;}
.vpost{
  scroll-snap-align:start;
  width:100%;height:100dvh;
  position:relative;overflow:hidden;
  background:var(--bg);
  display:flex;align-items:flex-end;
}

/* Photo carousel inside vpost */
.vpc-wrap{
  position:absolute;inset:0;
  display:flex;overflow-x:scroll;scroll-snap-type:x mandatory;
  scrollbar-width:none;
}
.vpc-wrap::-webkit-scrollbar{display:none;}
.vpc-slide{
  scroll-snap-align:start;
  flex-shrink:0;width:100%;height:100%;
  display:flex;align-items:center;justify-content:center;
  background:var(--bg);
}
.vpc-slide img{
  width:100%;height:100%;
  object-fit:cover;
  /* aspect-ratio switch via js */
}
.vpc-slide img.portrait{object-fit:cover;}
.vpc-slide img.landscape{object-fit:contain;background:#000;}
.vpc-placeholder{
  width:100%;height:100%;
  display:flex;align-items:center;justify-content:center;
  font-size:5rem;
}

/* overlay gradient */
.vpost-grad{
  position:absolute;inset:0;pointer-events:none;
  background:linear-gradient(to top,rgba(0,0,0,0.85) 0%,rgba(0,0,0,0.15) 45%,rgba(0,0,0,0.3) 100%);
  z-index:1;
}

/* photo dots */
.vpc-dots{
  position:absolute;top:12px;left:0;right:0;
  display:flex;justify-content:center;gap:4px;z-index:10;
}
.vpc-dot{
  height:3px;border-radius:2px;background:rgba(255,255,255,0.4);
  transition:all 0.25s;flex:1;max-width:28px;
}
.vpc-dot.on{background:#fff;}

/* right-side actions */
.vpost-actions{
  position:absolute;right:12px;bottom:130px;z-index:10;
  display:flex;flex-direction:column;align-items:center;gap:20px;
}
.va{display:flex;flex-direction:column;align-items:center;gap:4px;}
.va-btn{
  width:44px;height:44px;border-radius:50%;border:none;
  background:rgba(0,0,0,0.45);backdrop-filter:blur(10px);
  display:flex;align-items:center;justify-content:center;
  font-size:1.3rem;color:#fff;transition:transform 0.15s;
}
.va-btn:active{transform:scale(0.88);}
.va-btn.liked{background:rgba(255,95,143,0.3);}
.va-btn.saved{background:rgba(255,208,96,0.3);}
.va-count{font-size:0.7rem;font-weight:700;color:#fff;text-shadow:0 1px 4px rgba(0,0,0,0.8);}

/* bottom info */
.vpost-info{
  position:absolute;bottom:0;left:0;right:60px;z-index:10;
  padding:0 14px 110px;
}
.vpi-user{display:flex;align-items:center;gap:8px;margin-bottom:10px;cursor:pointer;}
.vpi-av{width:32px;height:32px;border-radius:50%;border:2px solid #fff;flex-shrink:0;overflow:hidden;background:var(--gr);display:flex;align-items:center;justify-content:center;font-size:0.8rem;font-weight:900;color:#fff;}
.vpi-av img{width:100%;height:100%;object-fit:cover;}
.vpi-name{font-size:0.9rem;font-weight:900;text-shadow:0 1px 4px rgba(0,0,0,0.8);}
.vpi-title{font-size:1.1rem;font-weight:900;text-shadow:0 1px 6px rgba(0,0,0,0.9);margin-bottom:6px;line-height:1.3;}
.vpi-loc{font-size:0.78rem;color:rgba(255,255,255,0.8);margin-bottom:8px;display:flex;align-items:center;gap:4px;}
.vpi-tags{display:flex;flex-wrap:wrap;gap:4px;margin-bottom:8px;}
.vpi-tag{font-size:0.78rem;font-weight:700;color:rgba(255,255,255,0.9);text-shadow:0 1px 3px rgba(0,0,0,0.8);}

/* music ticker */
.vpi-music{
  display:flex;align-items:center;gap:6px;
  background:rgba(0,0,0,0.5);backdrop-filter:blur(8px);
  border:1px solid rgba(255,255,255,0.1);border-radius:999px;
  padding:5px 12px 5px 8px;width:fit-content;max-width:220px;
}
.vpm-disc{
  width:22px;height:22px;border-radius:50%;background:var(--gr);
  flex-shrink:0;display:flex;align-items:center;justify-content:center;
  font-size:0.7rem;animation:spin 4s linear infinite;
}
.vpm-disc.paused{animation-play-state:paused;}
@keyframes spin{to{transform:rotate(360deg)}}
.vpm-text{font-size:0.7rem;color:#fff;white-space:nowrap;overflow:hidden;max-width:160px;}
.vpm-scroll{display:inline-block;animation:mscroll 10s linear infinite;}
@keyframes mscroll{0%{transform:translateX(0)}50%{transform:translateX(-50%)}100%{transform:translateX(0)}}

/* â”€â”€â”€ GRID MODE â”€â”€â”€ */
#gridFeed{
  position:absolute;inset:0;
  overflow-y:scroll;padding:52px 2px 90px;
  -webkit-overflow-scrolling:touch;
  display:none;
}
#gridFeed.on{display:block;}
.grid-cat-row{
  display:flex;gap:6px;padding:8px 12px;overflow-x:scroll;
  scrollbar-width:none;position:sticky;top:52px;z-index:50;
  background:var(--bg);
}
.grid-cat-row::-webkit-scrollbar{display:none;}
.gpill{background:var(--s2);border:1px solid var(--bd);border-radius:999px;padding:6px 14px;font-family:inherit;font-size:0.73rem;font-weight:600;color:var(--mu2);white-space:nowrap;flex-shrink:0;cursor:pointer;transition:all 0.2s;border:none;}
.gpill.on{background:var(--a2);color:#fff;}
.grid-2col{display:grid;grid-template-columns:1fr 1fr;gap:2px;padding:2px;}
.grid-card{position:relative;aspect-ratio:9/16;background:var(--s2);overflow:hidden;cursor:pointer;border-radius:2px;}
.grid-card img{width:100%;height:100%;object-fit:cover;}
.grid-placeholder{width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-size:2.8rem;}
.grid-card-ov{
  position:absolute;inset:0;
  background:linear-gradient(to top,rgba(0,0,0,0.7) 0%,transparent 50%);
  display:flex;flex-direction:column;justify-content:flex-end;padding:8px;
}
.gc-title{font-size:0.78rem;font-weight:900;text-shadow:0 1px 3px rgba(0,0,0,0.8);line-height:1.2;margin-bottom:2px;}
.gc-likes{font-size:0.65rem;color:rgba(255,255,255,0.7);}
.multi-badge{position:absolute;top:6px;right:6px;background:rgba(0,0,0,0.6);backdrop-filter:blur(6px);border-radius:6px;padding:2px 6px;font-size:0.65rem;font-weight:700;}

/* â”€â”€â”€ SEARCH BAR â”€â”€â”€ */
.srbar{
  margin:0 12px 8px;background:var(--s2);border:1px solid var(--bd);
  border-radius:14px;padding:10px 14px;display:none;
}
.srbar.on{display:flex;flex-wrap:wrap;align-items:center;gap:6px;}
.srbar-q{font-size:0.85rem;font-weight:900;flex:1;}
.srbar-n{font-size:0.7rem;color:var(--mu);width:100%;}
.srbar-x{background:none;border:1px solid var(--bd);border-radius:6px;padding:3px 8px;font-family:inherit;font-size:0.68rem;color:var(--mu);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BOTTOM NAV
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.bottomnav{
  position:absolute;bottom:0;left:0;right:0;z-index:300;
  background:rgba(6,6,8,0.97);backdrop-filter:blur(20px);
  border-top:1px solid var(--bd);
  display:flex;align-items:center;
  padding:6px 0 max(6px,env(safe-area-inset-bottom));
  height:64px;
}
.bn-item{flex:1;display:flex;flex-direction:column;align-items:center;gap:3px;cursor:pointer;color:var(--mu);transition:color 0.2s;}
.bn-item.on{color:#fff;}
.bn-icon{font-size:1.3rem;line-height:1;}
.bn-label{font-size:0.56rem;font-weight:700;letter-spacing:0.04em;}
.bn-post{
  width:50px;height:50px;border-radius:14px;background:var(--gr);
  display:flex;align-items:center;justify-content:center;
  font-size:1.6rem;cursor:pointer;
  box-shadow:0 0 20px rgba(167,139,255,0.5),0 0 40px rgba(255,95,143,0.3);
  transition:transform 0.15s;flex-shrink:0;margin-top:-14px;
}
.bn-post:active{transform:scale(0.9);}
.bn-center{flex:1;display:flex;flex-direction:column;align-items:center;gap:2px;}
.bn-center-lbl{font-size:0.56rem;font-weight:700;color:var(--mu);margin-top:2px;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SHEETS (bottom drawer)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.ov{position:fixed;inset:0;background:rgba(0,0,0,0.82);backdrop-filter:blur(6px);z-index:700;display:flex;align-items:flex-end;opacity:0;pointer-events:none;transition:opacity 0.28s;}
.ov.on{opacity:1;pointer-events:all;}
.sheet{
  background:var(--s1);border-radius:26px 26px 0 0;
  width:100%;max-height:96dvh;overflow-y:scroll;-webkit-overflow-scrolling:touch;
  transform:translateY(100%);transition:transform 0.35s cubic-bezier(0.25,0.8,0.25,1);
  border-top:1px solid var(--bd);scrollbar-width:none;
}
.ov.on .sheet{transform:translateY(0);}
.sh-handle{width:36px;height:4px;background:var(--s3);border-radius:2px;margin:12px auto 0;}
.sh-head{display:flex;align-items:center;justify-content:space-between;padding:14px 20px 12px;}
.sh-title{font-size:1rem;font-weight:900;}
.sh-x{width:30px;height:30px;border-radius:50%;background:var(--s2);border:none;color:var(--tx);font-size:0.85rem;display:flex;align-items:center;justify-content:center;}

/* â”€â”€ POST SHEET â”€â”€ */
.post-body{padding:0 18px 48px;}

/* Multi-photo selector */
.photo-slots{display:grid;grid-template-columns:repeat(4,1fr);gap:6px;margin-bottom:16px;}
.pslot{
  aspect-ratio:9/16;background:var(--s2);border:1.5px dashed rgba(167,139,255,0.35);
  border-radius:12px;display:flex;flex-direction:column;align-items:center;justify-content:center;
  font-size:1.3rem;cursor:pointer;position:relative;overflow:hidden;transition:border-color 0.2s;
}
.pslot:active{border-color:var(--a1);}
.pslot img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;}
.pslot-rm{position:absolute;top:3px;right:3px;width:18px;height:18px;border-radius:50%;background:rgba(255,95,143,0.9);border:none;color:#fff;font-size:0.6rem;font-weight:900;display:none;align-items:center;justify-content:center;}
.pslot.has-img .pslot-rm{display:flex;}
.pslot-num{position:absolute;bottom:2px;left:0;right:0;text-align:center;font-size:0.58rem;font-weight:700;color:rgba(255,255,255,0.6);background:rgba(0,0,0,0.4);}
.slots-hint{font-size:0.72rem;color:var(--mu);text-align:center;margin-bottom:16px;}

/* Orientation toggle */
.orient-row{display:flex;gap:8px;margin-bottom:16px;align-items:center;}
.orient-label{font-size:0.7rem;font-weight:700;color:var(--mu);text-transform:uppercase;letter-spacing:0.1em;flex-shrink:0;}
.orient-btn{flex:1;padding:8px;border:1px solid var(--bd);border-radius:10px;background:none;font-family:inherit;font-size:0.78rem;color:var(--mu2);cursor:pointer;transition:all 0.2s;display:flex;align-items:center;justify-content:center;gap:5px;}
.orient-btn.on{background:rgba(167,139,255,0.15);border-color:var(--a1);color:var(--a1);}

/* Music picker */
.music-picker{
  background:var(--s2);border:1px solid var(--bd);border-radius:16px;
  padding:14px;margin-bottom:16px;cursor:pointer;
  display:flex;align-items:center;gap:12px;transition:border-color 0.2s;
}
.music-picker:active{border-color:var(--a1);}
.mp-disc{width:40px;height:40px;border-radius:50%;background:var(--gr);display:flex;align-items:center;justify-content:center;font-size:1.1rem;flex-shrink:0;}
.mp-info{flex:1;}
.mp-label{font-size:0.68rem;color:var(--mu);margin-bottom:2px;}
.mp-track{font-size:0.88rem;font-weight:700;}
.mp-clear{background:var(--s3);border:none;border-radius:999px;padding:4px 10px;font-size:0.7rem;color:var(--mu2);flex-shrink:0;}

/* Music selection sheet */
.music-list{padding:0 18px 32px;}
.music-item{
  display:flex;align-items:center;gap:12px;padding:12px 0;
  border-bottom:1px solid var(--bd2);cursor:pointer;transition:background 0.15s;
}
.music-item:active{background:var(--s2);}
.music-item:last-child{border-bottom:none;}
.mi-disc{width:44px;height:44px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.2rem;flex-shrink:0;}
.mi-info{flex:1;}
.mi-title{font-size:0.88rem;font-weight:700;}
.mi-artist{font-size:0.72rem;color:var(--mu2);}
.mi-sel{width:22px;height:22px;border-radius:50%;border:2px solid var(--bd);background:none;display:flex;align-items:center;justify-content:center;font-size:0.7rem;transition:all 0.2s;flex-shrink:0;}
.mi-sel.on{background:var(--a1);border-color:var(--a1);color:#fff;}
.music-search{margin:0 18px 12px;position:relative;}
.music-search input{width:100%;background:var(--s2);border:1px solid var(--bd);border-radius:12px;padding:10px 14px;color:var(--tx);font-family:inherit;font-size:0.85rem;outline:none;}

.fg{margin-bottom:14px;}
.fl{display:block;font-size:0.66rem;font-weight:700;color:var(--mu);letter-spacing:0.15em;text-transform:uppercase;margin-bottom:6px;}
.fi,.fsel{width:100%;background:var(--s2);border:1px solid var(--bd);border-radius:13px;padding:12px 14px;color:var(--tx);font-family:inherit;font-size:0.88rem;outline:none;transition:border-color 0.2s;-webkit-appearance:none;appearance:none;}
.fi:focus,.fsel:focus{border-color:var(--a1);}
.fi::placeholder{color:var(--mu);}
.fta{min-height:80px;resize:none;line-height:1.6;}
.frow{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
.frow3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;}
.badge-picks{display:flex;gap:7px;flex-wrap:wrap;}
.bpick{display:flex;align-items:center;gap:5px;background:var(--s2);border:1px solid var(--bd);border-radius:10px;padding:7px 11px;font-size:0.78rem;cursor:pointer;}
.bpick input{accent-color:var(--a1);}
.sub-btn{width:100%;background:var(--gr);border:none;border-radius:16px;padding:16px;font-family:inherit;font-size:0.95rem;font-weight:900;color:#fff;margin-top:8px;}
.sub-btn:active{transform:scale(0.98);}

/* â”€â”€ DETAIL SHEET â”€â”€ */
.detail-sheet{max-height:96dvh;}
/* Photo viewer inside detail */
.dph-wrap{
  width:100%;position:relative;
  background:#000;overflow:hidden;
}
.dph-slides{
  display:flex;transition:transform 0.35s cubic-bezier(0.25,0.8,0.25,1);
}
.dph-slide{
  flex-shrink:0;width:100%;
  display:flex;align-items:center;justify-content:center;
}
.dph-slide img{width:100%;object-fit:contain;max-height:70dvh;}
.dph-slide img.portrait{object-fit:cover;aspect-ratio:9/16;}
.dph-placeholder{width:100%;aspect-ratio:9/16;display:flex;align-items:center;justify-content:center;font-size:5rem;}
.dph-dots{display:flex;justify-content:center;gap:5px;padding:10px 0 0;}
.dph-dot{width:6px;height:6px;border-radius:50%;background:var(--s3);transition:all 0.2s;}
.dph-dot.on{background:var(--a1);width:18px;border-radius:3px;}
.dph-prev,.dph-next{
  position:absolute;top:50%;transform:translateY(-50%);
  background:rgba(0,0,0,0.5);backdrop-filter:blur(8px);
  border:none;border-radius:50%;width:36px;height:36px;
  display:flex;align-items:center;justify-content:center;
  font-size:1rem;color:#fff;z-index:5;
}
.dph-prev{left:8px;}
.dph-next{right:8px;}

.d-body{padding:18px 18px 24px;}
.d-user{display:flex;align-items:center;gap:10px;margin-bottom:14px;}
.d-title{font-size:1.3rem;font-weight:900;letter-spacing:-0.02em;margin-bottom:4px;}
.d-loc{font-size:0.78rem;color:var(--mu2);margin-bottom:10px;}
.d-tags{display:flex;flex-wrap:wrap;gap:4px;margin-bottom:14px;}
.dtag{font-size:0.75rem;font-weight:700;color:var(--a1);padding:3px 0;}
.d-grid{display:grid;grid-template-columns:1fr 1fr;gap:7px;margin-bottom:14px;}
.dgi{background:var(--s2);border-radius:12px;padding:10px 12px;}
.dgi-l{font-size:0.6rem;color:var(--mu);letter-spacing:0.1em;text-transform:uppercase;margin-bottom:3px;}
.dgi-v{font-size:0.83rem;font-weight:700;}
.d-desc{background:var(--s2);border-radius:14px;padding:13px;font-size:0.83rem;line-height:1.75;color:rgba(242,242,255,0.82);margin-bottom:14px;}
.d-music{
  display:flex;align-items:center;gap:10px;background:var(--s2);
  border:1px solid var(--bd);border-radius:14px;padding:10px 14px;margin-bottom:16px;
}
.dm-disc{width:36px;height:36px;border-radius:50%;background:var(--gr);display:flex;align-items:center;justify-content:center;font-size:0.9rem;flex-shrink:0;animation:spin 4s linear infinite;}
.dm-info{flex:1;min-width:0;}
.dm-label{font-size:0.62rem;color:var(--mu);}
.dm-track{font-size:0.82rem;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.d-acts{display:flex;gap:8px;margin-bottom:18px;}
.dact{flex:1;border:none;border-radius:12px;padding:12px;font-family:inherit;font-size:0.82rem;font-weight:700;cursor:pointer;transition:all 0.15s;}
.dact.pr{background:var(--gr);color:#fff;}
.dact.se{background:var(--s2);border:1px solid var(--bd);color:var(--tx);}
.dact.se.liked{color:var(--a2);border-color:var(--a2);}
.dact.se.saved{color:var(--a4);border-color:var(--a4);}
.dact.se.fl{color:var(--a3);border-color:var(--a3);}
.dact:active{transform:scale(0.96);}

/* Comments */
.cmts-wrap{border-top:1px solid var(--bd);padding-top:14px;}
.cmts-title{font-size:0.88rem;font-weight:900;margin-bottom:12px;}
.ci-row{display:flex;gap:7px;margin-bottom:12px;}
.ci-inp{flex:1;background:var(--s2);border:1px solid var(--bd);border-radius:12px;padding:10px 13px;color:var(--tx);font-family:inherit;font-size:0.82rem;outline:none;}
.ci-inp:focus{border-color:var(--a1);}
.ci-snd{background:var(--gr);border:none;border-radius:12px;padding:10px 14px;color:#fff;font-size:0.95rem;}
.ci-snd:active{transform:scale(0.95);}
.cmt{display:flex;gap:8px;margin-bottom:10px;}
.cmt-av{width:28px;height:28px;border-radius:50%;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:0.7rem;font-weight:900;color:#fff;}
.cmt-body{flex:1;background:var(--s2);border-radius:12px;padding:8px 12px;}
.cmt-u{font-size:0.73rem;font-weight:700;color:var(--a1);margin-bottom:2px;cursor:pointer;}
.cmt-t{font-size:0.78rem;line-height:1.5;color:rgba(242,242,255,0.82);}
.cmt-time{font-size:0.6rem;color:var(--mu);margin-top:2px;}

/* â”€â”€ MAP â”€â”€ */
#mapScreen{background:var(--bg);}
.map-head{padding:58px 14px 10px;display:flex;gap:8px;background:var(--bg);}
.maptab{background:var(--s2);border:1px solid var(--bd);border-radius:10px;padding:8px 14px;font-family:inherit;font-size:0.77rem;font-weight:700;color:var(--mu2);cursor:pointer;transition:all 0.2s;border:none;}
.maptab.on{background:rgba(167,139,255,0.2);color:var(--a1);}
#theMap{flex:1;min-height:0;}
.leaflet-container{background:#0a0a14;}
.leaflet-popup-content-wrapper{background:var(--s2);color:var(--tx);border:1px solid var(--bd);border-radius:14px;}
.leaflet-popup-tip{background:var(--s2);}

/* â”€â”€ SAVED SCREEN â”€â”€ */
#savedScreen{background:var(--bg);}
.saved-head{padding:60px 16px 10px;font-size:0.95rem;font-weight:900;}
.saved-grid{flex:1;overflow-y:scroll;display:grid;grid-template-columns:1fr 1fr;gap:2px;padding:0 2px 80px;}

/* â”€â”€ MYPAGE â”€â”€ */
#mypageScreen{background:var(--bg);}
.myp-scroll{flex:1;overflow-y:scroll;-webkit-overflow-scrolling:touch;}
.myp-cover{height:150px;position:relative;flex-shrink:0;}
.myp-cover-bg{width:100%;height:100%;background:var(--gr);opacity:0.4;}
.myp-av-wrap{
  position:absolute;bottom:-38px;left:18px;
  width:76px;height:76px;border-radius:50%;
  border:4px solid var(--bg);overflow:hidden;
  background:var(--gr);display:flex;align-items:center;justify-content:center;
  font-size:1.8rem;font-weight:900;color:#fff;cursor:pointer;
}
.myp-av-wrap img{width:100%;height:100%;object-fit:cover;}
.myp-av-ov{position:absolute;inset:0;border-radius:50%;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;font-size:1.3rem;opacity:0;transition:opacity 0.2s;}
.myp-av-wrap:active .myp-av-ov{opacity:1;}
.myp-info-row{padding:48px 18px 16px;}
.myp-name{font-size:1.2rem;font-weight:900;}
.myp-uid{font-size:0.76rem;color:var(--mu);margin-bottom:10px;}
.myp-stats{display:flex;gap:18px;margin-bottom:14px;}
.mps-v{font-size:1rem;font-weight:900;}
.mps-l{font-size:0.63rem;color:var(--mu);}
.myp-sec{margin:0 14px 10px;background:var(--s1);border:1px solid var(--bd);border-radius:16px;overflow:hidden;}
.myp-sec-title{font-size:0.66rem;font-weight:700;color:var(--mu);letter-spacing:0.15em;text-transform:uppercase;padding:14px 16px 4px;}
.myp-row{display:flex;align-items:center;gap:12px;padding:13px 16px;border-bottom:1px solid var(--bd2);cursor:pointer;}
.myp-row:last-child{border-bottom:none;}
.myp-row:active{background:var(--s2);}
.myr-icon{font-size:1.1rem;width:22px;text-align:center;flex-shrink:0;}
.myr-lbl{font-size:0.85rem;flex:1;}
.myr-cnt{font-size:0.73rem;color:var(--mu);}
.myr-chev{font-size:0.8rem;color:var(--mu);}
.edit-sect{padding:16px;}
.edit-av-row{display:flex;align-items:center;gap:14px;margin-bottom:18px;}
.edit-av{width:60px;height:60px;border-radius:50%;background:var(--gr);flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:1.4rem;font-weight:900;color:#fff;overflow:hidden;cursor:pointer;position:relative;}
.edit-av img{width:100%;height:100%;object-fit:cover;}
.edit-av-ov{position:absolute;inset:0;border-radius:50%;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;font-size:1.2rem;opacity:0;transition:opacity 0.2s;}
.edit-av:active .edit-av-ov{opacity:1;}
.save-btn{width:100%;background:var(--gr);border:none;border-radius:14px;padding:14px;font-family:inherit;font-size:0.93rem;font-weight:900;color:#fff;}
.save-btn:active{transform:scale(0.98);}
.logout-btn{display:block;width:calc(100% - 28px);margin:4px 14px 32px;background:rgba(255,95,143,0.1);border:1px solid rgba(255,95,143,0.3);border-radius:14px;padding:14px;font-family:inherit;font-size:0.9rem;font-weight:700;color:var(--a2);}
.my-post-mini{display:flex;align-items:center;gap:10px;padding:12px 16px;border-bottom:1px solid var(--bd2);cursor:pointer;}
.my-post-mini:last-child{border-bottom:none;}
.mpm-thumb{width:44px;height:44px;border-radius:10px;flex-shrink:0;overflow:hidden;display:flex;align-items:center;justify-content:center;font-size:1.3rem;}
.mpm-thumb img{width:100%;height:100%;object-fit:cover;}
.mpm-info{flex:1;min-width:0;}
.mpm-title{font-size:0.84rem;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.mpm-sub{font-size:0.68rem;color:var(--mu);}
.mpm-del{background:rgba(255,95,143,0.12);border:1px solid rgba(255,95,143,0.3);border-radius:8px;padding:5px 9px;font-size:0.7rem;color:var(--a2);flex-shrink:0;}

/* USER PROFILE SHEET */
.uprof-cover{height:140px;position:relative;}
.uprof-cover-bg{width:100%;height:100%;background:var(--gr);opacity:0.35;}
.uprof-av{
  position:absolute;bottom:-36px;left:18px;
  width:72px;height:72px;border-radius:50%;border:4px solid var(--s1);
  overflow:hidden;background:var(--gr);display:flex;align-items:center;justify-content:center;font-size:1.7rem;color:#fff;
}
.uprof-av img{width:100%;height:100%;object-fit:cover;}
.uprof-info{padding:46px 18px 16px;}
.uprof-grid{display:grid;grid-template-columns:1fr 1fr;gap:6px;padding:0 14px 80px;}

/* TOAST */
.toast{
  position:fixed;bottom:76px;left:50%;transform:translateX(-50%) translateY(20px);
  background:rgba(30,30,40,0.95);backdrop-filter:blur(20px);
  border:1px solid var(--bd);border-radius:14px;
  padding:11px 20px;font-size:0.82rem;font-weight:600;z-index:1500;
  opacity:0;pointer-events:none;transition:all 0.25s;white-space:nowrap;
  box-shadow:0 8px 32px rgba(0,0,0,0.6);
}
.toast.on{opacity:1;transform:translateX(-50%) translateY(0);}
  /* â†“â†“â†“ã“ã“ã«è¿½åŠ â†“â†“â†“ */
@media (max-width: 430px){

  .topbar{
    gap:8px;
    padding:0 10px;
  }

  .tb-logo{
    font-size:1.1rem;
  }

  .tb-search{
    flex:1;
    min-width:0;
  }

  .tb-search input{
    min-width:0;
    font-size:0.8rem;
  }

  .tb-av{
    width:30px;
    height:30px;
    flex-shrink:0;
  }
}
/* â†‘â†‘â†‘ã“ã“ã¾ã§â†‘â†‘â†‘ */
</style>
  <!-- Firebase (compatã ã‘ä½¿ã†ï¼šwindow.db ã‚’ä½¿ã†ãŸã‚) -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyAr674Ds7ns-iKjTx4UPaN09hlo_LNu2rI",
    authDomain: "spoty-64d44.firebaseapp.com",
    projectId: "spoty-64d44",
    storageBucket: "spoty-64d44.firebasestorage.app",
    messagingSenderId: "337557449917",
    appId: "1:337557449917:web:40d383e007402e4d469bd4",
    measurementId: "G-PF7NFMQX3S"
  };

  firebase.initializeApp(firebaseConfig);
  window.db = firebase.firestore();
</script>
</head>
<body>

<!-- â•â•â•â• AUTH â•â•â•â• -->
<div id="authWrap">
  <div class="auth-logo-block">
    <span class="auth-pin">ğŸ“</span>
    <div class="auth-wordmark">Spoty</div>
    <div class="auth-tagline">æ—…ã€ã‚‚ã£ã¨è‡ªç”±ã«ã€‚ã‚ãªãŸã ã‘ã®ã‚¹ãƒãƒƒãƒˆã‚’ã€‚</div>
  </div>
  <div class="auth-card">
    <div class="auth-segs">
      <button class="auth-seg on" onclick="authSeg('login',this)">ãƒ­ã‚°ã‚¤ãƒ³</button>
      <button class="auth-seg" onclick="authSeg('reg',this)">æ–°è¦ç™»éŒ²</button>
    </div>
    <div id="ae" class="ae"></div>
    <div id="loginF">
      <div class="fg"><label class="fl">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label><input class="fi" id="lEm" type="email" placeholder="example@email.com" inputmode="email"></div>
      <div class="fg"><label class="fl">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label><input class="fi" id="lPw" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" onkeydown="if(event.key==='Enter')doLogin()"></div>
      <button class="auth-btn" onclick="doLogin()">ãƒ­ã‚°ã‚¤ãƒ³ â†’</button>
      <div class="demo-note">ãƒ‡ãƒ¢ç”¨: test@spoty.jp / password123</div>
    </div>
    <div id="regF" style="display:none;">
      <div class="fg"><label class="fl">ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ </label><input class="fi" id="rNm" type="text" placeholder="ä¾‹ï¼šæ—…å¥½ãå¤ªéƒ"></div>
      <div class="fg"><label class="fl">ãƒ¦ãƒ¼ã‚¶ãƒ¼IDï¼ˆè‹±æ•°å­—ãƒ»_ï¼‰</label><input class="fi" id="rId" type="text" placeholder="tabi_taro" oninput="this.value=this.value.replace(/[^a-zA-Z0-9_]/g,'').toLowerCase()"></div>
      <div class="fg"><label class="fl">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label><input class="fi" id="rEm" type="email" placeholder="example@email.com" inputmode="email"></div>
      <div class="fg"><label class="fl">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆ8æ–‡å­—ä»¥ä¸Šï¼‰</label><input class="fi" id="rPw" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" onkeydown="if(event.key==='Enter')doReg()"></div>
      <button class="auth-btn" onclick="doReg()">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆ â†’</button>
    </div>
  </div>
</div>

<!-- â•â•â•â• APP â•â•â•â• -->
<div id="app">
  <!-- Top bar -->
  <div class="topbar">
    <div class="tb-logo" onclick="refreshSpoty()">ğŸ“ Spoty</div>
    <div class="tb-search">
      <span style="color:var(--mu2);font-size:0.85rem;">ğŸ”</span>
      <input id="srchIn" type="text" placeholder="ã€Œæ±äº¬ è‡ªç„¶ã€ã€Œå·å´ã€ã€Œæ¸‹è°· å–«èŒ¶åº—ã€..." onkeydown="if(event.key==='Enter')doSearch()">
      <button onclick="doSearch()">â†’</button>
    </div>
    <div class="tb-av" id="topAv" onclick="switchSc('mypage')"></div>
  </div>

  <!-- Screens -->
  <div class="screens">

    <!-- â”€â”€ FEED â”€â”€ -->
    <div class="screen on" id="feedScreen">
      <!-- Mode toggle: vert / grid -->
      <div class="feed-mode-toggle">
        <button class="fmt-btn on" id="fmtVert" onclick="setFeedMode('vert')">â–¦ ç¸¦</button>
        <button class="fmt-btn" id="fmtGrid" onclick="setFeedMode('grid')">âŠ ã‚°ãƒªãƒƒãƒ‰</button>
      </div>
      <!-- Tab bar (only visible in grid mode) -->
      <div class="feed-tabs" id="feedTabs" style="display:none;">
        <button class="ftab on" onclick="setFeedTab(this,'new')">ğŸ†• æ–°ç€</button>
        <button class="ftab" onclick="setFeedTab(this,'popular')">ğŸ”¥ äººæ°—</button>
        <button class="ftab" onclick="setFeedTab(this,'rec')">âœ¨ ãŠã™ã™ã‚</button>
      </div>

      <!-- Vertical scroll feed (TikTok) -->
      <div id="vertFeed"></div>

      <!-- Grid feed (Instagram) -->
      <div id="gridFeed">
        <div class="grid-cat-row" id="gridCats">
          <button class="gpill on" onclick="setCat(this,'all')">ã™ã¹ã¦</button>
          <button class="gpill" onclick="setCat(this,'è‡ªç„¶')">ğŸŒ¿ è‡ªç„¶</button>
          <button class="gpill" onclick="setCat(this,'ã‚«ãƒ•ã‚§')">â˜• ã‚«ãƒ•ã‚§</button>
          <button class="gpill" onclick="setCat(this,'ã‚°ãƒ«ãƒ¡')">ğŸœ ã‚°ãƒ«ãƒ¡</button>
          <button class="gpill" onclick="setCat(this,'æ¸©æ³‰')">â™¨ï¸ æ¸©æ³‰</button>
          <button class="gpill" onclick="setCat(this,'çµ¶æ™¯')">ğŸŒ… çµ¶æ™¯</button>
          <button class="gpill" onclick="setCat(this,'ç©´å ´')">ğŸ”® ç©´å ´</button>
          <button class="gpill" onclick="setCat(this,'å¤œæ™¯')">ğŸŒ™ å¤œæ™¯</button>
          <button class="gpill" onclick="setCat(this,'ãƒ‰ãƒ©ã‚¤ãƒ–')">ğŸš— ãƒ‰ãƒ©ã‚¤ãƒ–</button>
        </div>
        <div class="srbar" id="srbar">
          <div class="srbar-q" id="srbar-q"></div>
          <button class="srbar-x" onclick="clearSrch()">âœ•</button>
          <div class="srbar-n" id="srbar-n"></div>
        </div>
        <div class="grid-2col" id="gridList"></div>
      </div>
    </div>

    <!-- â”€â”€ MAP â”€â”€ -->
    <div class="screen" id="mapScreen" style="display:none;">
      <div class="map-head">
        <button class="maptab on" id="mt-all" onclick="setMapTab(this,'all')">ğŸ“ å…¨ã‚¹ãƒãƒƒãƒˆ</button>
        <button class="maptab" id="mt-sv" onclick="setMapTab(this,'saved')">ğŸ”– ä¿å­˜æ¸ˆã¿</button>
      </div>
      <div id="theMap"></div>
    </div>

    <!-- â”€â”€ SAVED â”€â”€ -->
    <div class="screen" id="savedScreen" style="display:none;">
      <div class="saved-head">ğŸ”– ä¿å­˜æ¸ˆã¿ã‚¹ãƒãƒƒãƒˆ</div>
      <div class="saved-grid" id="savedGrid"></div>
    </div>

    <!-- â”€â”€ MYPAGE â”€â”€ -->
    <div class="screen" id="mypageScreen" style="display:none;">
      <div class="myp-scroll" id="mypageInner"></div>
    </div>

  </div><!-- /screens -->

  <!-- Bottom Nav -->
  <nav class="bottomnav">
    <div class="bn-item on" id="bn-feed" onclick="switchSc('feed')"><span class="bn-icon">ğŸ </span><span class="bn-label">ãƒ›ãƒ¼ãƒ </span></div>
    <div class="bn-item" id="bn-map" onclick="switchSc('map')"><span class="bn-icon">ğŸ—ºï¸</span><span class="bn-label">ãƒãƒƒãƒ—</span></div>
    <div class="bn-center" onclick="openPostSheet()"><div class="bn-post">ï¼‹</div><div class="bn-center-lbl">æŠ•ç¨¿</div></div>
    <div class="bn-item" id="bn-saved" onclick="switchSc('saved')"><span class="bn-icon">ğŸ”–</span><span class="bn-label">ä¿å­˜</span></div>
    <div class="bn-item" id="bn-mypage" onclick="switchSc('mypage')"><span class="bn-icon">ğŸ‘¤</span><span class="bn-label">ãƒã‚¤ãƒšãƒ¼ã‚¸</span></div>
  </nav>
</div>

<!-- â•â•â•â• POST SHEET â•â•â•â• -->
<div class="ov" id="postOv">
  <div class="sheet">
    <div class="sh-handle"></div>
    <div class="sh-head"><div class="sh-title">ğŸ“ ã‚¹ãƒãƒƒãƒˆã‚’æŠ•ç¨¿</div><button class="sh-x" onclick="closeOv('postOv')">âœ•</button></div>
    <div class="post-body">

      <!-- å†™çœŸã‚¹ãƒ­ãƒƒãƒˆï¼ˆæœ€å¤§8æšï¼‰ -->
      <div class="fg">
        <label class="fl">ğŸ“· å†™çœŸï¼ˆæœ€å¤§8æšã€ç¸¦æ¨ªOKï¼‰</label>
        <div class="photo-slots" id="photoSlots"></div>
        <div class="slots-hint">ï¼‹ ã‚’ã‚¿ãƒƒãƒ—ã—ã¦å†™çœŸã‚’è¿½åŠ ï¼ˆæœ€å¤§8æšï¼‰</div>
      </div>

      <!-- å‘ãé¸æŠ -->
      <div class="orient-row">
        <span class="orient-label">å†™çœŸã®å‘ã</span>
        <button class="orient-btn on" id="ov-port" onclick="setOrient('portrait',this)">ğŸ“± ç¸¦ï¼ˆ9:16ï¼‰</button>
        <button class="orient-btn" id="ov-land" onclick="setOrient('landscape',this)">ğŸ–¼ï¸ æ¨ªï¼ˆ16:9ï¼‰</button>
        <button class="orient-btn" id="ov-sq" onclick="setOrient('square',this)">â¬› æ­£æ–¹å½¢</button>
      </div>

      <!-- éŸ³æ¥½ -->
      <div class="fg">
        <label class="fl">ğŸµ BGMã‚’è¿½åŠ ï¼ˆä»»æ„ï¼‰</label>
        <div class="music-picker" id="musicPicker" onclick="openMusicSheet()">
          <div class="mp-disc">ğŸµ</div>
          <div class="mp-info">
            <div class="mp-label">BGMã‚’é¸æŠ</div>
            <div class="mp-track" id="mpTrack">æ›²ã‚’é¸ã‚“ã§æŠ•ç¨¿ã«é›°å›²æ°—ã‚’</div>
          </div>
          <button class="mp-clear" id="mpClear" onclick="clearMusic(event)" style="display:none;">âœ•</button>
        </div>
      </div>

      <div class="fg"><label class="fl">ã‚¹ãƒãƒƒãƒˆå *</label><input class="fi" id="pTitle" type="text" placeholder="ä¾‹ï¼šè‰åƒé‡Œãƒ¶æµœ"></div>
      <div class="frow">
        <div class="fg"><label class="fl">éƒ½é“åºœçœŒãƒ»åœ°åŸŸ *</label><input class="fi" id="pPref" type="text" placeholder="ä¾‹ï¼šç†Šæœ¬çœŒ"></div>
        <div class="fg">
  <label class="fl">ã‚«ãƒ†ã‚´ãƒªï¼ˆè¤‡æ•°OKï¼‰ *</label>
  <div class="badge-picks" id="catPicks">
    <label class="bpick"><input type="checkbox" class="catChk" value="è‡ªç„¶"> ğŸŒ¿ è‡ªç„¶</label>
    <label class="bpick"><input type="checkbox" class="catChk" value="ã‚«ãƒ•ã‚§"> â˜• ã‚«ãƒ•ã‚§</label>
    <label class="bpick"><input type="checkbox" class="catChk" value="ã‚°ãƒ«ãƒ¡"> ğŸœ ã‚°ãƒ«ãƒ¡</label>
    <label class="bpick"><input type="checkbox" class="catChk" value="æ¸©æ³‰"> â™¨ï¸ æ¸©æ³‰</label>
    <label class="bpick"><input type="checkbox" class="catChk" value="çµ¶æ™¯"> ğŸŒ… çµ¶æ™¯</label>
    <label class="bpick"><input type="checkbox" class="catChk" value="è¦³å…‰"> ğŸ¯ è¦³å…‰</label>
    <label class="bpick"><input type="checkbox" class="catChk" value="å¤œæ™¯"> ğŸŒ™ å¤œæ™¯</label>
    <label class="bpick"><input type="checkbox" class="catChk" value="ä½“é¨“"> ğŸ­ ä½“é¨“</label>
    <label class="bpick"><input type="checkbox" class="catChk" value="ç©´å ´"> ğŸ”® ç©´å ´</label>
    <label class="bpick"><input type="checkbox" class="catChk" value="ãƒ‰ãƒ©ã‚¤ãƒ–"> ğŸš— ãƒ‰ãƒ©ã‚¤ãƒ–</label>
    <label class="bpick"><input type="checkbox" class="catChk" value="ãã®ä»–"> ğŸ“Œ ãã®ä»–</label>
  </div>
</div>
      <div class="frow3">
        <div class="fg"><label class="fl">è¨ªå•å¹´ *</label><select class="fsel" id="pYr"><option value="2025">2025å¹´</option><option value="2024">2024å¹´</option><option value="2023">2023å¹´</option><option value="2022">2022å¹´</option></select></div>
        <div class="fg"><label class="fl">æœˆ *</label><select class="fsel" id="pMo"><option value="1">1æœˆ</option><option value="2">2æœˆ</option><option value="3">3æœˆ</option><option value="4">4æœˆ</option><option value="5">5æœˆ</option><option value="6">6æœˆ</option><option value="7">7æœˆ</option><option value="8">8æœˆ</option><option value="9">9æœˆ</option><option value="10">10æœˆ</option><option value="11">11æœˆ</option><option value="12">12æœˆ</option></select></div>
        <div class="fg"><label class="fl">æ™‚é–“å¸¯ *</label><select class="fsel" id="pTm"><option value="æ—©æœ">æ—©æœ</option><option value="åˆå‰">åˆå‰</option><option value="æ˜¼">æ˜¼</option><option value="åˆå¾Œ">åˆå¾Œ</option><option value="å¤•æ–¹">å¤•æ–¹</option><option value="å¤œ">å¤œ</option></select></div>
      </div>
      <div class="frow">
        <div class="fg"><label class="fl">æ··é›‘åº¦</label><select class="fsel" id="pCr"><option value="ç©ºã„ã¦ã„ãŸ">ğŸŸ¢ ç©ºã„ã¦ã„ãŸ</option><option value="æ™®é€š">ğŸŸ¡ æ™®é€š</option><option value="æ··é›‘ã—ã¦ã„ãŸ">ğŸ”´ æ··é›‘ã—ã¦ã„ãŸ</option></select></div>
        <div class="fg"><label class="fl">ãŠã™ã™ã‚åº¦</label><select class="fsel" id="pRt"><option value="5">â­â­â­â­â­</option><option value="4">â­â­â­â­</option><option value="3">â­â­â­</option><option value="2">â­â­</option></select></div>
      </div>
      <div class="fg"><label class="fl">ã‚³ãƒ¡ãƒ³ãƒˆãƒ»è©³ç´° *</label><textarea class="fi fta" id="pDsc" placeholder="è¡Œã£ãŸæ„Ÿæƒ³ã€ãŠã™ã™ã‚ãƒã‚¤ãƒ³ãƒˆã€ã‚¢ã‚¯ã‚»ã‚¹æ–¹æ³•..."></textarea></div>
      <div class="fg"><label class="fl">ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ï¼ˆã‚¹ãƒšãƒ¼ã‚¹åŒºåˆ‡ã‚Šï¼‰</label><input class="fi" id="pTgs" type="text" placeholder="ä¾‹ï¼šè‰åƒé‡Œ çµ¶æ™¯ ç©´å ´ ã‚¤ãƒ³ã‚¹ã‚¿æ˜ ãˆ"></div>
      <div class="fg"><label class="fl">ãƒãƒƒã‚¸</label>
        <div class="badge-picks">
          <label class="bpick"><input type="checkbox" id="bLo"> ğŸ  åœ°å…ƒæ°‘</label>
          <label class="bpick"><input type="checkbox" id="bHi"> ğŸ”® ç©´å ´</label>
          <label class="bpick"><input type="checkbox" id="bPh"> ğŸ“¸ æ˜ ãˆ</label>
        </div>
      </div>
      <button class="sub-btn" onclick="submitPost()">ğŸ“ æŠ•ç¨¿ã™ã‚‹</button>
    </div>
  </div>
</div>
<input type="file" id="picInput" accept="image/*" style="display:none;" onchange="handlePicFile(event)">

<!-- â•â•â•â• MUSIC SHEET â•â•â•â• -->
<div class="ov" id="musicOv">
  <div class="sheet">
    <div class="sh-handle"></div>
    <div class="sh-head"><div class="sh-title">ğŸµ BGMã‚’é¸ã¶</div><button class="sh-x" onclick="closeOv('musicOv')">âœ•</button></div>
    <div class="music-search"><input class="fi" id="musicSrch" type="text" placeholder="æ›²åãƒ»ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆã§æ¤œç´¢..." oninput="renderMusicList()"></div>
    <div class="music-list" id="musicList"></div>
  </div>
</div>

<!-- â•â•â•â• DETAIL SHEET â•â•â•â• -->
<div class="ov" id="detailOv">
  <div class="sheet detail-sheet" id="detailInner"></div>
</div>

<!-- â•â•â•â• USER PROFILE SHEET â•â•â•â• -->
<div class="ov" id="profOv">
  <div class="sheet detail-sheet" id="profInner"></div>
</div>

<!-- Hidden inputs -->
<input type="file" id="avInput" accept="image/*" style="display:none;" onchange="handleAv(event)">

<!-- TOAST -->
<div class="toast" id="toast"></div>

<script>
/* â•â• STATE â•â• */
let posts=[],users={},cu=null;
let feedMode='vert',feedTab='new',curCat='all',srch='';
let selPhotos=[],selOrient='portrait',selMusic=null;
let picSlotIdx=0;
let mapInst=null,mapMkrs=[],mapFilter='all';

const sv=(k,v)=>{try{localStorage.setItem('sp4_'+k,JSON.stringify(v));}catch(e){}};
const ld=(k,d)=>{try{const v=localStorage.getItem('sp4_'+k);return v?JSON.parse(v):d;}catch(e){return d;}};

/* â•â• MUSIC CATALOGUE â•â• */
const MUSIC=[
  {id:'m1',title:'æ˜¥é¢¨',artist:'å¤•æš®ã‚Œãƒãƒ³ãƒ‰',emoji:'ğŸŒ¸',genre:'jpop'},
  {id:'m2',title:'Tokyo Drive',artist:'Night City FM',emoji:'ğŸš—',genre:'city pop'},
  {id:'m3',title:'å¤ã®å¤•æš®ã‚Œ',artist:'æµ·è¾ºã‚µã‚¦ãƒ³ã‚º',emoji:'ğŸŒŠ',genre:'chill'},
  {id:'m4',title:'å±±é ‚',artist:'YAMA',emoji:'ğŸ”ï¸',genre:'indie'},
  {id:'m5',title:'Neon Rain',artist:'Cyber Pop',emoji:'ğŸŒ™',genre:'electronic'},
  {id:'m6',title:'æ¸©æ³‰ã®æœ',artist:'å’Œé¢¨ãƒ¡ãƒ­ãƒ‡ã‚£',emoji:'â™¨ï¸',genre:'japanese'},
  {id:'m7',title:'æ£®ã®æ•£æ­©',artist:'Nature Sounds',emoji:'ğŸŒ¿',genre:'ambient'},
  {id:'m8',title:'Sakura Breeze',artist:'Lofi Japan',emoji:'ğŸŒ¸',genre:'lofi'},
  {id:'m9',title:'è¡—ã®ç¯ã‚Š',artist:'ã‚·ãƒ†ã‚£ãƒãƒƒãƒ—',emoji:'âœ¨',genre:'city pop'},
  {id:'m10',title:'æ—…ã®å§‹ã¾ã‚Š',artist:'Road Trip',emoji:'ğŸ’',genre:'acoustic'},
  {id:'m11',title:'æ¸‹è°·ã®å¤œ',artist:'Urban Nights',emoji:'ğŸ¸',genre:'jazz'},
  {id:'m12',title:'Coastal Highway',artist:'Sunset Vibes',emoji:'ğŸŒ…',genre:'indie'},
  {id:'m13',title:'é›¨ã®æ—¥',artist:'Rain Drop',emoji:'ğŸŒ§ï¸',genre:'melancholic'},
  {id:'m14',title:'Kawasaki Factory',artist:'Industrial Beats',emoji:'ğŸ­',genre:'electronic'},
  {id:'m15',title:'æº€é–‹',artist:'Sakura Records',emoji:'ğŸŒº',genre:'jpop'},
  {id:'m16',title:'Deep Forest',artist:'å¥¥å¤šæ‘©ã‚µã‚¦ãƒ³ã‚º',emoji:'ğŸŒ²',genre:'ambient'},
];

/* â•â• INIT â•â• */
function init(){
  posts=ld('posts',seedPosts());
  users=ld('users',{'test@spoty.jp':{name:'ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼',uid:'test_user',pass:'password123',av:null,following:[],createdAt:Date.now()}});
  const sess=ld('sess',null);
  if(sess&&users[sess]){cu={email:sess,...users[sess]};launch();}
  sv('posts',posts);sv('users',users);
  initPhotoSlots();
    // ===== Firestore: å…¨å“¡ã®æŠ•ç¨¿ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸ =====
  window.db.collection("posts")
    .orderBy("createdAt", "desc")
    .onSnapshot((snap) => {
      const ALLOW = new Set([
        "æ±äº¬éƒ½","ç¥å¥ˆå·çœŒ",
        "ç¦å²¡çœŒ","ä½è³€çœŒ","é•·å´çœŒ","ç†Šæœ¬çœŒ","å¤§åˆ†çœŒ","å®®å´çœŒ","é¹¿å…å³¶çœŒ"
      ]);

      posts = snap.docs
        .map(d => ({ id: d.id, ...d.data() }))
        .filter(p => ALLOW.has(p.pref));

      // ç”»é¢ã‚’æ›´æ–°
      if (typeof renderVert === "function") renderVert();
      if (typeof renderGrid === "function") renderGrid();
      if (typeof renderMypage === "function") renderMypage();

      // ãƒ­ãƒ¼ã‚«ãƒ«ã«ã‚‚ä¿å­˜ï¼ˆã‚ªãƒ•ãƒ©ã‚¤ãƒ³æ™‚ã®è¡¨ç¤ºç”¨ï¼‰
      sv('posts', posts);
    }, (err) => {
      console.error("Firestore onSnapshot error:", err);
    });
}

/* â•â• AUTH â•â• */
function authSeg(t,el){
  document.querySelectorAll('.auth-seg').forEach(x=>x.classList.remove('on'));el.classList.add('on');
  document.getElementById('loginF').style.display=t==='login'?'block':'none';
  document.getElementById('regF').style.display=t==='reg'?'block':'none';
  document.getElementById('ae').style.display='none';
}
function authErr(m){const e=document.getElementById('ae');e.textContent=m;e.style.display='block';}
function doLogin(){
  const em=document.getElementById('lEm').value.trim(),pw=document.getElementById('lPw').value;
  if(!em||!pw)return authErr('å…¥åŠ›ã—ã¦ãã ã•ã„');
  const u=users[em];if(!u||u.pass!==pw)return authErr('ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™');
  cu={email:em,...u};sv('sess',em);launch();
}
function doReg(){
  const nm=document.getElementById('rNm').value.trim(),uid=document.getElementById('rId').value.trim();
  const em=document.getElementById('rEm').value.trim(),pw=document.getElementById('rPw').value;
  if(!nm||!uid||!em||!pw)return authErr('ã™ã¹ã¦å…¥åŠ›ã—ã¦ãã ã•ã„');
  if(pw.length<8)return authErr('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯8æ–‡å­—ä»¥ä¸Š');
  if(users[em])return authErr('ã“ã®ãƒ¡ãƒ¼ãƒ«ã¯ã™ã§ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™');
  if(Object.values(users).some(u=>u.uid===uid))return authErr('ã“ã®IDã¯ã™ã§ã«ä½¿ã‚ã‚Œã¦ã„ã¾ã™');
  users[em]={name:nm,uid,pass:pw,av:null,following:[],createdAt:Date.now()};
  sv('users',users);cu={email:em,...users[em]};sv('sess',em);launch();
}
function doLogout(){sv('sess',null);cu=null;document.getElementById('app').style.display='none';document.getElementById('authWrap').style.display='flex';}
function launch(){
  document.getElementById('authWrap').style.display='none';
  document.getElementById('app').style.display='flex';
  updTopAv();renderVert();renderMypage();
}
function updTopAv(){
  const el=document.getElementById('topAv');if(!cu)return;
  el.innerHTML=cu.av?`<img src="${cu.av}">`:(cu.name||'?').charAt(0).toUpperCase();
}

/* â•â• SCREEN SWITCHING â•â• */
const scMap={feed:'feedScreen',map:'mapScreen',saved:'savedScreen',mypage:'mypageScreen'};
const bnMap={feed:'bn-feed',map:'bn-map',saved:'bn-saved',mypage:'bn-mypage'};
let curSc='feed';
function switchSc(s){
  Object.entries(scMap).forEach(([k,id])=>{const el=document.getElementById(id);el.classList.remove('on');el.style.display='none';});
  const el=document.getElementById(scMap[s]);el.style.display='flex';el.classList.add('on');
  document.querySelectorAll('.bn-item').forEach(x=>x.classList.remove('on'));
  const bn=document.getElementById(bnMap[s]);if(bn)bn.classList.add('on');
  curSc=s;
  if(s==='map')initMap();
  if(s==='saved')renderSaved();
  if(s==='mypage')renderMypage();
}
function gotoFeed(){switchSc('feed');}

/* â•â• FEED MODE â•â• */
function setFeedMode(m){
  feedMode=m;
  document.getElementById('fmtVert').classList.toggle('on',m==='vert');
  document.getElementById('fmtGrid').classList.toggle('on',m==='grid');
  document.getElementById('vertFeed').style.display=m==='vert'?'block':'none';
  document.getElementById('gridFeed').classList.toggle('on',m==='grid');
  document.getElementById('feedTabs').style.display=m==='grid'?'flex':'none';
  if(m==='vert')renderVert();else renderGrid();
}

/* â•â• FEED TAB â•â• */
function setFeedTab(el,t){
  document.querySelectorAll('.ftab').forEach(x=>x.classList.remove('on'));el.classList.add('on');
  feedTab=t;renderGrid();
}

/* â•â• CATEGORY â•â• */
function setCat(el,c){
  document.querySelectorAll('.gpill').forEach(x=>x.classList.remove('on'));el.classList.add('on');
  curCat=c;renderGrid();
}

/* â•â• SEARCH â•â• */
function doSearch(){srch=document.getElementById('srchIn').value.trim();setFeedMode('grid');renderGrid();}
function clearSrch(){document.getElementById('srchIn').value='';srch='';renderGrid();}

/* â•â• FILTER POSTS â•â• */
const catE={è‡ªç„¶:'ğŸŒ¿',ã‚«ãƒ•ã‚§:'â˜•',ã‚°ãƒ«ãƒ¡:'ğŸœ',æ¸©æ³‰:'â™¨ï¸',çµ¶æ™¯:'ğŸŒ…',è¦³å…‰:'ğŸ¯',å¤œæ™¯:'ğŸŒ™',ä½“é¨“:'ğŸ­',ç©´å ´:'ğŸ”®',ãƒ‰ãƒ©ã‚¤ãƒ–:'ğŸš—'};
const clrs=['pm1','pm2','pm3','pm4','pm5','pm6','pm7','pm8'];

function getFiltered(){
  let list=[...posts];
  if(srch){
    const terms=srch.toLowerCase().trim().split(/[\sã€€]+/).filter(Boolean);
    list=list.filter(p=>{const h=[p.title,p.pref,p.cat,p.desc,...(p.tags||[]),p.uName,p.uid].join(' ').toLowerCase();return terms.every(t=>h.includes(t));});
  }
  if(curCat!=='all')list=list.filter(p=>p.cat===curCat||(p.tags||[]).some(t=>t.includes(curCat))||(p.desc||'').includes(curCat));
  if(feedTab==='popular')list.sort((a,b)=>b.likes-a.likes);
  else if(feedTab==='rec'){
    const myT=new Set();posts.filter(p=>(p.likedBy||[]).includes(cu?.uid)).forEach(p=>(p.tags||[]).forEach(t=>myT.add(t)));
    list.sort((a,b)=>{const sa=(a.tags||[]).filter(t=>myT.has(t)).length*300+a.likes;const sb=(b.tags||[]).filter(t=>myT.has(t)).length*300+b.likes;return sb-sa;});
  }
  else list.sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));
  return list;
}

/* â•â• VERTICAL FEED â•â• */
function renderVert(){
  const list=getFiltered();
  const vf=document.getElementById('vertFeed');
  if(!list.length){vf.innerHTML='<div style="height:100dvh;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:12px;"><span style="font-size:3rem;">ğŸ—ºï¸</span><div style="font-size:0.95rem;font-weight:700;">æŠ•ç¨¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</div></div>';return;}
  vf.innerHTML=list.map(p=>vpostHtml(p)).join('');
  // Initialize carousels
  list.forEach(p=>{
    const wrap=document.getElementById('vpc_'+p.id);
    if(!wrap)return;
    wrap.addEventListener('scroll',()=>updateDots(p.id,wrap),{passive:true});
  });
}

function vpostHtml(p){
  const photos=p.photos||[];
  const liked=cu&&(p.likedBy||[]).includes(cu.uid);
  const saved=cu&&(p.savedBy||[]).includes(cu.uid);
  const tags=(p.tags||[]).slice(0,4).map(t=>`<span class="vpi-tag">#${t}</span>`).join('');
  const avHtml=p.uAv?`<img src="${p.uAv}">`:(p.uName||'?').charAt(0).toUpperCase();
  const badges=[(p.badges?.local?'ğŸ ':''),(p.badges?.hidden?'ğŸ”®':''),(p.badges?.photo?'ğŸ“¸':'')].filter(Boolean).join('');

  // Photos
  let mediaHtml='';
  if(photos.length>0){
    const slides=photos.map(ph=>`<div class="vpc-slide"><img src="${ph}" class="${p.orient||'portrait'}"></div>`).join('');
    const dots=photos.length>1?`<div class="vpc-dots">${photos.map((_,i)=>`<div class="vpc-dot ${i===0?'on':''}" id="dot_${p.id}_${i}"></div>`).join('')}</div>`:'';
    mediaHtml=`<div class="vpc-wrap" id="vpc_${p.id}">${slides}</div>${dots}`;
  }else{
    mediaHtml=`<div class="vpc-wrap" id="vpc_${p.id}"><div class="vpc-slide"><div class="vpc-placeholder ${p.clr}">${catE[p.cat]||'ğŸ“'}</div></div></div>`;
  }

  const musicHtml=p.music?`<div class="vpi-music"><div class="vpm-disc">ğŸµ</div><div class="vpm-text"><span class="vpm-scroll">${p.music.title} - ${p.music.artist} &nbsp;&nbsp;&nbsp; ${p.music.title} - ${p.music.artist}</span></div></div>`:'';

  return`<div class="vpost" id="vp_${p.id}">
    ${mediaHtml}
    <div class="vpost-grad"></div>
    <div class="vpost-actions">
      <div class="va">
        <button class="va-btn ${liked?'liked':''}" onclick="toggleLike('${p.id}',true)"><span>${liked?'â¤ï¸':'ğŸ¤'}</span></button>
        <span class="va-count">${fn(p.likes)}</span>
      </div>
      <div class="va">
        <button class="va-btn" onclick="openDetail('${p.id}')"><span>ğŸ’¬</span></button>
        <span class="va-count">${(p.comments||[]).length}</span>
      </div>
      <div class="va">
        <button class="va-btn ${saved?'saved':''}" onclick="toggleSave('${p.id}',true)"><span>${saved?'ğŸ”–':'ğŸ”–'}</span></button>
        <span class="va-count">${saved?'æ¸ˆ':'ä¿å­˜'}</span>
      </div>
      <div class="va">
        <button class="va-btn" onclick="openDetail('${p.id}')"><span>â„¹ï¸</span></button>
        <span class="va-count">è©³ç´°</span>
      </div>
    </div>
    <div class="vpost-info">
      <div class="vpi-user" onclick="openProf('${p.uid}')">
        <div class="vpi-av" style="background:${sc(p.uid)}">${avHtml}</div>
        <span class="vpi-name">@${p.uName||p.uid}</span>
        ${badges?`<span style="font-size:0.9rem;">${badges}</span>`:''}
      </div>
      <div class="vpi-title">${p.title}</div>
      <div class="vpi-loc">ğŸ“ ${p.pref} Â· ${p.cat}</div>
      <div class="vpi-tags">${tags}</div>
      ${musicHtml}
    </div>
  </div>`;
}

function updateDots(pid,wrap){
  const idx=Math.round(wrap.scrollLeft/wrap.offsetWidth);
  const p=posts.find(x=>x.id===pid);if(!p)return;
  (p.photos||[]).forEach((_,i)=>{
    const d=document.getElementById(`dot_${pid}_${i}`);
    if(d)d.classList.toggle('on',i===idx);
  });
}

/* â•â• GRID FEED â•â• */
function renderGrid(){
  const list=getFiltered();
  // search bar
  const bar=document.getElementById('srbar');
  if(srch){bar.classList.add('on');document.getElementById('srbar-q').textContent=`ğŸ”ã€Œ${srch}ã€`;document.getElementById('srbar-n').textContent=`${list.length}ä»¶`;}
  else bar.classList.remove('on');

  const gl=document.getElementById('gridList');
  if(!list.length){gl.innerHTML='<div style="padding:40px;text-align:center;color:var(--mu);grid-column:1/-1;font-size:0.88rem;">æŠ•ç¨¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</div>';return;}
  gl.innerHTML=list.map(p=>{
    const thumb=p.photos?.[0]?`<img src="${p.photos[0]}" loading="lazy">`:`<div class="grid-placeholder ${p.clr}">${catE[p.cat]||'ğŸ“'}</div>`;
    const multi=(p.photos||[]).length>1?`<div class="multi-badge">âŠ ${p.photos.length}</div>`:'';
    const music=p.music?`<div style="position:absolute;top:6px;left:6px;background:rgba(0,0,0,0.6);border-radius:999px;padding:2px 7px;font-size:0.6rem;">ğŸµ</div>`:'';
    return`<div class="grid-card" onclick="openDetail('${p.id}')">
      ${thumb}${multi}${music}
      <div class="grid-card-ov">
        <div class="gc-title">${p.title}</div>
        <div class="gc-likes">â¤ï¸${fn(p.likes)} Â· ğŸ’¬${(p.comments||[]).length}</div>
      </div>
    </div>`;
  }).join('');
}

/* â•â• LIKE / SAVE / DELETE â•â• */
function toggleLike(id,reVert=false){
  if(!cu) return toast('ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™');

  const p = posts.find(x=>x.id===id);
  if(!p) return;

  p.likedBy = p.likedBy || [];
  const i = p.likedBy.indexOf(cu.uid);

  if(i>=0){
    p.likedBy.splice(i,1);
    p.likes = Math.max(0,(p.likes||0)-1);
    toast('ğŸ¤ ã„ã„ã­å–ã‚Šæ¶ˆã—');
  }else{
    p.likedBy.push(cu.uid);
    p.likes = (p.likes||0)+1;
    toast('â¤ï¸ ã„ã„ã­ï¼');
  }

  // ğŸ”¥ Firestoreã«ä¿å­˜ï¼ˆã“ã‚ŒãŒè¶…é‡è¦ï¼‰
  window.db.collection("posts").doc(id).update({
    likes: p.likes,
    likedBy: p.likedBy
  }).catch(err=>{
    console.error(err);
    toast('âš ï¸ ã„ã„ã­ä¿å­˜ã«å¤±æ•—');
  });

  // ç”»é¢ã¯å³æ›´æ–°ï¼ˆonSnapshotã§ã‚‚å¾Œã§è¿½å¾“ã™ã‚‹ï¼‰
  if(feedMode==='vert'||reVert) renderVert(); else renderGrid();
}

function toggleSave(id,reVert=false){
  if(!cu) return toast('ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™');

  const p = posts.find(x=>x.id===id);
  if(!p) return;

  p.savedBy = p.savedBy || [];
  const i = p.savedBy.indexOf(cu.uid);

  if(i>=0){
    p.savedBy.splice(i,1);
    toast('ä¿å­˜è§£é™¤');
  }else{
    p.savedBy.push(cu.uid);
    toast('ğŸ”– ä¿å­˜ã—ã¾ã—ãŸï¼');
  }

  // ğŸ”¥ Firestoreã«ä¿å­˜
  window.db.collection("posts").doc(id).update({
    savedBy: p.savedBy
  }).catch(err=>{
    console.error(err);
    toast('âš ï¸ ä¿å­˜ã«å¤±æ•—');
  });

  if(feedMode==='vert'||reVert) renderVert(); else renderGrid();
  if(curSc==='saved') renderSaved();
}

function delPost(id){
  if(!confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;

  // ğŸ”¥ Firestoreã‹ã‚‰å‰Šé™¤ï¼ˆonSnapshotã§æ¶ˆãˆã‚‹ï¼‰
  window.db.collection("posts").doc(id).delete()
    .then(()=>toast('ğŸ—‘ï¸ å‰Šé™¤ã—ã¾ã—ãŸ'))
    .catch(err=>{
      console.error(err);
      toast('âš ï¸ å‰Šé™¤ã«å¤±æ•—');
    });
}

/* â•â• FOLLOWï¼ˆâ€»ã¾ã localStorageé‹ç”¨ã®ã¾ã¾ã§OKã€‚Firestoreã«ã—ãŸã‘ã‚Œã°æ¬¡ã§ï¼‰ â•â• */
const isF=uid=>cu&&(users[cu.email]?.following||[]).includes(uid);
function toggleFollow(uid){
  if(!cu) return toast('ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™');
  if(uid===cu.uid) return toast('è‡ªåˆ†ã¯ãƒ•ã‚©ãƒ­ãƒ¼ã§ãã¾ã›ã‚“');

  const u=users[cu.email];
  u.following=u.following||[];
  const i=u.following.indexOf(uid);

  if(i>=0){u.following.splice(i,1);toast('ãƒ•ã‚©ãƒ­ãƒ¼è§£é™¤');}
  else{u.following.push(uid);toast(`âœ… @${uid} ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¾ã—ãŸï¼`);}

  cu={email:cu.email,...u};
  sv('users',users);
}
/* â•â• DETAIL SHEET â•â• */
function openDetail(id){
  const pid = String(id).trim();
  const p = posts.find(x => String(x.id).trim() === pid);

  if(!p){
    console.error('âŒ openDetail: æŠ•ç¨¿ãŒè¦‹ã¤ã‹ã‚‰ãªã„', { id, pid, postsLen: posts.length, sample: posts[0] });
    toast('æŠ•ç¨¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
    return;
  }

  const liked = cu && (p.likedBy || []).includes(cu.uid);
  const saved = cu && (p.savedBy || []).includes(cu.uid);
  const fol = isF(p.uid);
  const isMe = cu && p.uid === cu.uid;
  const photos = Array.isArray(p.photos) ? p.photos : []; // â† nullå¯¾ç­–ï¼ˆè¶…é‡è¦ï¼‰
  const stars = 'â­'.repeat(Math.min(+p.rating || 5, 5));
  const tags = (p.tags || []).map(t => `<span class="dtag">#${t}</span>`).join('');
  const avHtml = p.uAv ? <img src="${p.uAv}"> : (p.uName || '?').charAt(0).toUpperCase();

  // Photo viewer
  const photoH=photos.length
    ?`<div class="dph-wrap" id="dphWrap" data-pid="${id}">
        <div class="dph-slides" id="dphSlides">${photos.map((ph,i)=>`<div class="dph-slide"><img src="${ph}" class="${p.orient||'portrait'}" id="dph_${i}"></div>`).join('')}</div>
        ${photos.length>1?`<button class="dph-prev" onclick="dphNav(-1,'${id}')">â€¹</button><button class="dph-next" onclick="dphNav(1,'${id}')">â€º</button>`:''}
        <div class="dph-dots">${photos.map((_,i)=>`<div class="dph-dot ${i===0?'on':''}" id="ddot_${id}_${i}"></div>`).join('')}</div>
      </div>`
    :`<div class="dph-placeholder ${p.clr}">${catE[p.cat]||'ğŸ“'}</div>`;

  const musicH=p.music?`<div class="d-music"><div class="dm-disc">ğŸµ</div><div class="dm-info"><div class="dm-label">BGM</div><div class="dm-track">${p.music.title} - ${p.music.artist}</div></div><span style="font-size:1rem;">${p.music.emoji}</span></div>`:'';
  const cmts=(p.comments||[]).map(c=>`<div class="cmt"><div class="cmt-av" style="background:${sc(c.uid)};width:28px;height:28px;font-size:0.7rem;">${(c.uName||'?').charAt(0).toUpperCase()}</div><div class="cmt-body"><div class="cmt-u" onclick="openProf('${c.uid}')">@${c.uName||c.uid}</div><div class="cmt-t">${c.text}</div><div class="cmt-time">${c.time}</div></div></div>`).join('')||'<div style="color:var(--mu);font-size:0.8rem;text-align:center;padding:12px;">ã¾ã ã‚³ãƒ¡ãƒ³ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“</div>';

  document.getElementById('detailInner').innerHTML=`
    <div class="sh-handle"></div>
    <div class="sh-head"><div class="sh-title">ğŸ“ ã‚¹ãƒãƒƒãƒˆè©³ç´°</div><button class="sh-x" onclick="closeOv('detailOv')">âœ•</button></div>
    ${photoH}
    <div class="d-body">
      <div class="d-user">
        <div class="cmt-av" style="background:${sc(p.uid)};width:34px;height:34px;font-size:0.82rem;cursor:pointer;border-radius:50%;" onclick="openProf('${p.uid}')">${avHtml}</div>
        <div style="flex:1;cursor:pointer;" onclick="openProf('${p.uid}')"><div style="font-size:0.85rem;font-weight:700;">@${p.uName||p.uid}</div><div style="font-size:0.68rem;color:var(--mu);">${p.year}å¹´${p.month}æœˆæŠ•ç¨¿</div></div>
        ${!isMe?`<button onclick="dFol('${p.uid}',this)" class="dact se ${fol?'fl':''}" style="flex:0;padding:7px 13px;font-size:0.76rem;">${fol?'âœ…ãƒ•ã‚©ãƒ­ãƒ¼ä¸­':'â•ãƒ•ã‚©ãƒ­ãƒ¼'}</button>`:''}
      </div>
      <div class="d-title">${p.title}</div>
      <div class="d-loc">ğŸ“ ${p.pref} Â· ${p.cat}</div>
      <div class="d-tags">${tags}</div>
      <div class="d-grid">
        <div class="dgi"><div class="dgi-l">è¨ªå•æ™‚æœŸ</div><div class="dgi-v">ğŸ“… ${p.year}å¹´${p.month}æœˆ</div></div>
        <div class="dgi"><div class="dgi-l">æ™‚é–“å¸¯</div><div class="dgi-v">ğŸ• ${p.time}</div></div>
        <div class="dgi"><div class="dgi-l">æ··é›‘åº¦</div><div class="dgi-v">${ce(p.crowd)} ${p.crowd}</div></div>
        <div class="dgi"><div class="dgi-l">ãŠã™ã™ã‚åº¦</div><div class="dgi-v">${stars}</div></div>
      </div>
      <div class="d-desc">${p.desc}</div>
      ${musicH}
      <div class="d-acts">
        <button class="dact pr" onclick="document.getElementById('srchIn').value='${p.pref.replace(/[éƒ½é“åºœçœŒ]/,'')}';doSearch();closeOv('detailOv')">ğŸ” åŒåœ°åŸŸ</button>
        <button class="dact se ${liked?'liked':''}" onclick="toggleLike('${p.id}');openDetail('${p.id}')">${liked?'â¤ï¸':'ğŸ¤'} ${fn(p.likes)}</button>
        <button class="dact se ${saved?'saved':''}" onclick="toggleSave('${p.id}');openDetail('${p.id}')">ğŸ”– ${saved?'æ¸ˆ':'ä¿å­˜'}</button>
      </div>
      <div class="cmts-wrap">
        <div class="cmts-title">ğŸ’¬ ã‚³ãƒ¡ãƒ³ãƒˆ <span style="color:var(--mu);font-weight:400;font-size:0.8rem;">${(p.comments||[]).length}ä»¶</span></div>
        <div class="ci-row">
          <input class="ci-inp" id="ci_${p.id}" type="text" placeholder="ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›¸ã..." onkeydown="if(event.key==='Enter')addCmt('${p.id}')">
          <button class="ci-snd" onclick="addCmt('${p.id}')">â†’</button>
        </div>
        <div id="cl_${p.id}">${cmts}</div>
      </div>
    </div>`;
  document.getElementById('detailOv').classList.add('on');
}
let dphIdx={};
function dphNav(dir,pid){
  const p=posts.find(x=>x.id===pid);if(!p||!(p.photos||[]).length)return;
  dphIdx[pid]=(dphIdx[pid]||0)+dir;
  dphIdx[pid]=Math.max(0,Math.min(dphIdx[pid],(p.photos||[]).length-1));
  const slides=document.getElementById('dphSlides');
  if(slides)slides.style.transform=`translateX(-${dphIdx[pid]*100}%)`;
  (p.photos||[]).forEach((_,i)=>{const d=document.getElementById(`ddot_${pid}_${i}`);if(d)d.classList.toggle('on',i===dphIdx[pid]);});
}
function dFol(uid,btn){toggleFollow(uid);const f=isF(uid);btn.textContent=f?'âœ…ãƒ•ã‚©ãƒ­ãƒ¼ä¸­':'â•ãƒ•ã‚©ãƒ­ãƒ¼';btn.className=`dact se ${f?'fl':''}`;}
function addCmt(pid){
  const inp=document.getElementById(`ci_${pid}`);const text=(inp?.value||'').trim();if(!text)return;
  if(!cu)return toast('ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™');
  const p=posts.find(x=>x.id===pid);if(!p)return;
  p.comments=p.comments||[];
  p.comments.push({id:'c'+Date.now(),uid:cu.uid,uName:cu.name,text,time:'ãŸã£ãŸä»Š'});
  sv('posts',posts);inp.value='';openDetail(pid);toast('ğŸ’¬ ã‚³ãƒ¡ãƒ³ãƒˆã—ã¾ã—ãŸï¼');
}

/* â•â• USER PROFILE SHEET â•â• */
function openProf(uid){
  const uPosts=posts.filter(p=>p.uid===uid);
  const u=Object.values(users).find(x=>x.uid===uid);
  const f=isF(uid);const isMe=cu&&cu.uid===uid;
  const av=(u?.av||uPosts[0]?.uAv)?`<img src="${u?.av||uPosts[0]?.uAv}">`:`<span style="font-size:1.8rem;">${uid.charAt(0).toUpperCase()}</span>`;
  document.getElementById('profInner').innerHTML=`
    <div class="sh-handle"></div>
    <div class="sh-head"><div class="sh-title">ğŸ‘¤ ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</div><button class="sh-x" onclick="closeOv('profOv')">âœ•</button></div>
    <div class="uprof-cover"><div class="uprof-cover-bg"></div><div class="uprof-av" style="background:${sc(uid)}">${av}</div></div>
    <div class="uprof-info">
      <div style="font-size:1.1rem;font-weight:900;">${u?.name||uid}</div>
      <div style="font-size:0.76rem;color:var(--mu);margin-bottom:8px;">@${uid}</div>
      <div style="display:flex;gap:16px;margin-bottom:12px;">
        <div><div style="font-size:0.98rem;font-weight:900;">${uPosts.length}</div><div style="font-size:0.63rem;color:var(--mu);">æŠ•ç¨¿</div></div>
        <div><div style="font-size:0.98rem;font-weight:900;">${uPosts.reduce((s,p)=>s+p.likes,0)}</div><div style="font-size:0.63rem;color:var(--mu);">ã„ã„ã­è¨ˆ</div></div>
      </div>
      ${!isMe?`<button onclick="pfFol('${uid}',this)" style="background:${f?'rgba(0,229,160,0.12)':'var(--gr)'};border:${f?'1px solid var(--a3)':'none'};color:${f?'var(--a3)':'#fff'};border-radius:10px;padding:9px 18px;font-family:inherit;font-size:0.82rem;font-weight:700;cursor:pointer;margin-bottom:14px;">${f?'âœ…ãƒ•ã‚©ãƒ­ãƒ¼ä¸­':'â•ãƒ•ã‚©ãƒ­ãƒ¼ã™ã‚‹'}</button>`:`<button onclick="closeOv('profOv');switchSc('mypage')" style="background:var(--s2);border:1px solid var(--bd);border-radius:10px;padding:9px 18px;font-family:inherit;font-size:0.82rem;font-weight:700;cursor:pointer;color:var(--tx);margin-bottom:14px;">âš™ï¸ ãƒ—ãƒ­ãƒ•ç·¨é›†</button>`}
      <div style="font-size:0.75rem;font-weight:700;color:var(--mu);margin-bottom:8px;">ğŸ“ æŠ•ç¨¿ï¼ˆ${uPosts.length}ä»¶ï¼‰</div>
    </div>
    <div class="uprof-grid">${uPosts.length?uPosts.map(p=>{
      const th=p.photos?.[0]?`<img src="${p.photos[0]}" style="width:100%;height:100%;object-fit:cover;">`:`<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-size:2.5rem;">${catE[p.cat]||'ğŸ“'}</div>`;
      return`<div class="grid-card" onclick="closeOv('profOv');openDetail('${p.id}')"><div class="grid-placeholder ${p.clr}" style="height:100%;">${th}</div><div class="grid-card-ov"><div class="gc-title">${p.title}</div><div class="gc-likes">â¤ï¸${fn(p.likes)}</div></div></div>`;
    }).join(''):'<div style="color:var(--mu);font-size:0.82rem;padding:16px;grid-column:1/-1;">ã¾ã æŠ•ç¨¿ã¯ã‚ã‚Šã¾ã›ã‚“</div>'}
    </div>`;
  document.getElementById('profOv').classList.add('on');
}
function pfFol(uid,btn){toggleFollow(uid);const f=isF(uid);btn.textContent=f?'âœ…ãƒ•ã‚©ãƒ­ãƒ¼ä¸­':'â•ãƒ•ã‚©ãƒ­ãƒ¼ã™ã‚‹';btn.style.background=f?'rgba(0,229,160,0.12)':'var(--gr)';btn.style.color=f?'var(--a3)':'#fff';}

/* â•â• POST SHEET â•â• */
function initPhotoSlots(){
  const grid=document.getElementById('photoSlots');
  grid.innerHTML='';
  for(let i=0;i<8;i++){
    const div=document.createElement('div');
    div.className='pslot';
    div.id='pslot_'+i;
    if(selPhotos[i]){
      div.classList.add('has-img');
      div.innerHTML=`<img src="${selPhotos[i]}"><button class="pslot-rm" onclick="rmPhoto(${i},event)">âœ•</button><div class="pslot-num">${i+1}</div>`;
    }else if(i===selPhotos.length){
      div.innerHTML=`<span>ï¼‹</span>`;
      div.onclick=()=>triggerPicSlot(i);
    }else if(i<selPhotos.length){
      div.innerHTML=`<span style="font-size:0.7rem;color:var(--mu);">ç©ºã</span>`;
    }else{
      div.style.opacity='0.3';
      div.innerHTML=`<span style="font-size:0.8rem;color:var(--mu);">${i+1}</span>`;
    }
    grid.appendChild(div);
  }
}
function triggerPicSlot(idx){
  picSlotIdx = idx;
  document.getElementById('picInput').click();
}

async function handlePicFile(e){
  const f = e.target.files[0];
  if(!f) return;

  try{
    const img = new Image();
    img.src = URL.createObjectURL(f);
    await new Promise((res, rej) => { img.onload = res; img.onerror = rej; });

    const MAX_W = 1080;
    const scale = Math.min(1, MAX_W / img.width);
    const w = Math.round(img.width * scale);
    const h = Math.round(img.height * scale);

    const canvas = document.createElement('canvas');
    canvas.width = w;
    canvas.height = h;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(img, 0, 0, w, h);

    const dataUrl = canvas.toDataURL('image/jpeg', 0.7);

    if(selPhotos.filter(Boolean).length >= 8) return toast('å†™çœŸã¯æœ€å¤§8æšã§ã™');
    selPhotos[picSlotIdx] = dataUrl;

    initPhotoSlots();
    URL.revokeObjectURL(img.src);
  }catch(err){
    console.error(err);
    toast('ç”»åƒã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
  }

  e.target.value = '';
}

function rmPhoto(idx,e){
  if(e) e.stopPropagation();
  selPhotos.splice(idx,1);
  initPhotoSlots();
}
function rmPhoto(idx,e){if(e)e.stopPropagation();selPhotos.splice(idx,1);initPhotoSlots();}

let selOrientVal='portrait';
function setOrient(v,el){
  selOrientVal=v;
  document.querySelectorAll('.orient-btn').forEach(x=>x.classList.remove('on'));
  el.classList.add('on');
}
function openPostSheet(){document.getElementById('postOv').classList.add('on');}

/* Music */
let selMusicObj=null;
function openMusicSheet(){
  renderMusicList();
  document.getElementById('musicOv').classList.add('on');
}
function renderMusicList(){
  const q=(document.getElementById('musicSrch')?.value||'').toLowerCase();
  const filtered=q?MUSIC.filter(m=>m.title.toLowerCase().includes(q)||m.artist.toLowerCase().includes(q)):MUSIC;
  document.getElementById('musicList').innerHTML=filtered.map(m=>{
    const on=selMusicObj?.id===m.id;
    const bg=`background:linear-gradient(135deg,hsl(${hashColor(m.id)},65%,30%),hsl(${(hashColor(m.id)+40)%360},65%,25%))`;
    return`<div class="music-item" onclick="selectMusic('${m.id}')">
      <div class="mi-disc" style="${bg}">${m.emoji}</div>
      <div class="mi-info"><div class="mi-title">${m.title}</div><div class="mi-artist">${m.artist}</div></div>
      <div class="mi-sel ${on?'on':''}">${on?'âœ“':''}</div>
    </div>`;
  }).join('');
}
function selectMusic(id){
  const m=MUSIC.find(x=>x.id===id);if(!m)return;
  selMusicObj=selMusicObj?.id===id?null:m;
  document.getElementById('mpTrack').textContent=selMusicObj?`${selMusicObj.title} - ${selMusicObj.artist}`:'æ›²ã‚’é¸ã‚“ã§æŠ•ç¨¿ã«é›°å›²æ°—ã‚’';
  document.getElementById('mpClear').style.display=selMusicObj?'block':'none';
  renderMusicList();
  if(selMusicObj)setTimeout(()=>closeOv('musicOv'),300);
}
function clearMusic(e){if(e)e.stopPropagation();selMusicObj=null;document.getElementById('mpTrack').textContent='æ›²ã‚’é¸ã‚“ã§æŠ•ç¨¿ã«é›°å›²æ°—ã‚’';document.getElementById('mpClear').style.display='none';}
function hashColor(s){let h=0;for(const c of s)h=(h<<5)-h+c.charCodeAt(0);return Math.abs(h)%360;}

function submitPost(){
  if(!cu) return toast('ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™');

  // ã©ã®IDãŒç„¡ã„ã‹å³ã‚ã‹ã‚‹ãƒã‚§ãƒƒã‚¯é–¢æ•°
  const el = (id) => {
    const x = document.getElementById(id);
    if(!x){
      console.error('âŒ missing element id =', id);
      toast(`âŒ ç”»é¢éƒ¨å“ãŒè¦‹ã¤ã‹ã‚‰ãªã„: ${id}`);
      throw new Error('missing element: ' + id);
    }
    return x;
  };
  const val = (id) => el(id).value;

  const title = val('pTitle').trim();

  // âœ… éƒ½é“åºœçœŒã‚’æ­£è¦åŒ–ï¼ˆ"æ±äº¬"â†’"æ±äº¬éƒ½" ãªã©ï¼‰
  const pref = normPref(val('pPref').trim());

  // âœ… ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‹ã‚‰ã‚«ãƒ†ã‚´ãƒªè¤‡æ•°å–å¾—
  const cats = Array.from(document.querySelectorAll('.catChk:checked'))
    .map(x => x.value)
    .filter(Boolean);

  // äº’æ›ç”¨ï¼ˆæ—§è¡¨ç¤ºãŒ p.cat å‰æãªã®ã§å…ˆé ­ã‚’ cat ã«ï¼‰
  const cat = cats[0] || '';

  const desc = val('pDsc').trim();

  // âœ… å¿…é ˆãƒã‚§ãƒƒã‚¯
  if(!title || !pref || cats.length===0 || !desc){
    return toast('âš ï¸ å¿…é ˆé …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
  }

  const rawTags = val('pTgs').trim()
    .split(/[\sã€€,]+/)
    .filter(Boolean)
    .map(t=>t.replace(/^#/,''));

  const ps = pref.replace(/[éƒ½é“åºœçœŒ]/,'');
  if(ps && !rawTags.includes(ps)) rawTags.push(ps);

  const np = {
    id: 'p'+Date.now(),
    photos: (selPhotos||[]).filter(Boolean).length ? [...(selPhotos||[]).filter(Boolean)] : null,
    orient: selOrientVal || 'portrait',
    music: selMusicObj ? {...selMusicObj} : null,

    title,
    pref,
    cat,   // å…ˆé ­1å€‹ï¼ˆäº’æ›ï¼‰
    cats,  // âœ… è¤‡æ•°ã‚«ãƒ†ã‚´ãƒªï¼ˆæ–°ä»•æ§˜ï¼‰

    year:  +val('pYr'),
    month: +val('pMo'),
    time:  val('pTm'),
    crowd: val('pCr'),
    rating:+val('pRt'),

    desc,
    tags: rawTags,

    uid: cu.uid,
    uName: cu.name,
    uAv: cu.av || null,

    badges:{
      local: el('bLo').checked,
      hidden: el('bHi').checked,
      photo: el('bPh').checked
    },

    likes:0, likedBy:[], savedBy:[], comments:[],
    clr: clrs[Math.floor(Math.random()*clrs.length)],
    createdAt: Date.now(),
    lat: rLat(pref),
    lng: rLng(pref)
  };

  window.db.collection("posts").add(np).then(()=>{

    // reset
    ['pTitle','pPref','pDsc','pTgs'].forEach(id=>el(id).value='');

    // âœ… ã‚«ãƒ†ã‚´ãƒªï¼ˆãƒã‚§ãƒƒã‚¯ï¼‰ã‚’å…¨éƒ¨OFF
    document.querySelectorAll('.catChk').forEach(x => x.checked = false);

    ['bLo','bHi','bPh'].forEach(id=>el(id).checked=false);

    selPhotos=[];
    selMusicObj=null;

    const mpTrack=document.getElementById('mpTrack');
    const mpClear=document.getElementById('mpClear');
    if(mpTrack) mpTrack.textContent='æ›²ã‚’é¸ã‚“ã§æŠ•ç¨¿ã«é›°å›²æ°—ã‚’';
    if(mpClear) mpClear.style.display='none';

    initPhotoSlots();
    closeOv('postOv');
    toast('ğŸ“ æŠ•ç¨¿ã—ã¾ã—ãŸï¼ğŸ‰');

  }).catch((e)=>{
    console.error('Firestore add error:', e);
    toast('æŠ•ç¨¿ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆæ¨©é™/é€šä¿¡/ãƒ«ãƒ¼ãƒ«ç¢ºèªï¼‰');
  });
}
/* â•â• SAVED â•â• */
function renderSaved(){
  const list=posts.filter(p=>cu&&(p.savedBy||[]).includes(cu.uid));
  const grid=document.getElementById('savedGrid');
  if(!list.length){grid.innerHTML='<div style="padding:40px;text-align:center;color:var(--mu);grid-column:1/-1;font-size:0.88rem;">ã¾ã ä¿å­˜ã¯ã‚ã‚Šã¾ã›ã‚“<br>æ°—ã«ãªã£ãŸã‚¹ãƒãƒƒãƒˆã‚’ä¿å­˜ã—ã‚ˆã†ï¼</div>';return;}
  grid.innerHTML=list.map(p=>{
    const th=p.photos?.[0]?`<img src="${p.photos[0]}" loading="lazy">`:`<div class="grid-placeholder ${p.clr}">${catE[p.cat]||'ğŸ“'}</div>`;
    return`<div class="grid-card" onclick="openDetail('${p.id}')">
      ${th}
      <div class="grid-card-ov"><div class="gc-title">${p.title}</div><div class="gc-likes">ğŸ“ ${p.pref}</div></div>
    </div>`;
  }).join('');
}

/* â•â• MYPAGE â•â• */
function renderMypage(){
  if(!cu)return;
  const u=users[cu.email];
  const mine=posts.filter(p=>p.uid===cu.uid);
  const liked=posts.filter(p=>(p.likedBy||[]).includes(cu.uid));
  const saved=posts.filter(p=>(p.savedBy||[]).includes(cu.uid));
  const avH=cu.av?`<img src="${cu.av}">`:`<span>${cu.name.charAt(0).toUpperCase()}</span>`;

  document.getElementById('mypageInner').innerHTML=`
    <div class="myp-cover"><div class="myp-cover-bg"></div>
      <div class="myp-av-wrap" style="background:${sc(cu.uid)}" onclick="document.getElementById('avInput').click()">
        ${avH}<div class="myp-av-ov">ğŸ“·</div>
      </div>
    </div>
    <div class="myp-info-row">
      <div class="myp-name">${cu.name}</div>
      <div class="myp-uid">@${cu.uid}</div>
      <div class="myp-stats">
        <div><div class="mps-v">${mine.length}</div><div class="mps-l">æŠ•ç¨¿</div></div>
        <div><div class="mps-v">${liked.length}</div><div class="mps-l">ã„ã„ã­</div></div>
        <div><div class="mps-v">${saved.length}</div><div class="mps-l">ä¿å­˜</div></div>
        <div><div class="mps-v">${(u?.following||[]).length}</div><div class="mps-l">ãƒ•ã‚©ãƒ­ãƒ¼</div></div>
      </div>
    </div>

    <div class="myp-sec">
      <div class="myp-sec-title">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†</div>
      <div class="edit-sect">
        <div class="edit-av-row">
          <div class="edit-av" onclick="document.getElementById('avInput').click()" id="editAvEl" style="background:${sc(cu.uid)}">${avH}<div class="edit-av-ov">ğŸ“·</div></div>
          <div><div style="font-size:0.85rem;font-weight:700;margin-bottom:2px;">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å†™çœŸã‚’å¤‰æ›´</div><div style="font-size:0.72rem;color:var(--mu);">å¥½ããªå†™çœŸã«å¤‰æ›´ã§ãã¾ã™</div></div>
        </div>
        <div class="fg"><label class="fl">ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ </label><input class="fi" id="eNm" type="text" value="${cu.name}"></div>
        <div class="fg"><label class="fl">ãƒ¦ãƒ¼ã‚¶ãƒ¼ID</label><input class="fi" id="eUid" type="text" value="${cu.uid}" oninput="this.value=this.value.replace(/[^a-zA-Z0-9_]/g,'').toLowerCase()"></div>
        <button class="save-btn" onclick="saveProf()">å¤‰æ›´ã‚’ä¿å­˜</button>
      </div>
    </div>

    <div class="myp-sec">
      <div class="myp-sec-title">ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£</div>
      <div class="myp-row" onclick="viewMine()"><span class="myr-icon">ğŸ“</span><span class="myr-lbl">è‡ªåˆ†ã®æŠ•ç¨¿ã‚’è¦‹ã‚‹</span><span class="myr-cnt">${mine.length}ä»¶</span><span class="myr-chev">â€º</span></div>
      <div class="myp-row" onclick="viewLiked()"><span class="myr-icon">â¤ï¸</span><span class="myr-lbl">ã„ã„ã­ã—ãŸæŠ•ç¨¿</span><span class="myr-cnt">${liked.length}ä»¶</span><span class="myr-chev">â€º</span></div>
      <div class="myp-row" onclick="switchSc('saved')"><span class="myr-icon">ğŸ”–</span><span class="myr-lbl">ä¿å­˜æ¸ˆã¿ã‚¹ãƒãƒƒãƒˆ</span><span class="myr-cnt">${saved.length}ä»¶</span><span class="myr-chev">â€º</span></div>
      <div class="myp-row"><span class="myr-icon">ğŸ‘¥</span><span class="myr-lbl">ãƒ•ã‚©ãƒ­ãƒ¼ä¸­</span><span class="myr-cnt">${(u?.following||[]).length}äºº</span><span class="myr-chev">â€º</span></div>
    </div>

    ${mine.length?`<div class="myp-sec">
      <div class="myp-sec-title">ğŸ“ æŠ•ç¨¿ç®¡ç†</div>
      ${mine.slice(0,6).map(p=>`
        <div class="my-post-mini" onclick="openDetail('${p.id}')">
          <div class="mpm-thumb ${p.clr}">${p.photos?.[0]?`<img src="${p.photos[0]}">`:(catE[p.cat]||'ğŸ“')}</div>
          <div class="mpm-info"><div class="mpm-title">${p.title}</div><div class="mpm-sub">${p.pref} Â· â¤ï¸${p.likes} ${p.music?'Â· ğŸµ':''}</div></div>
          <button class="mpm-del" onclick="event.stopPropagation();delPost('${p.id}')">å‰Šé™¤</button>
        </div>`).join('')}
    </div>`:''}

    <button class="logout-btn" onclick="doLogout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
  `;
}
function handleAv(e){
  const f=e.target.files[0];if(!f)return;
  const r=new FileReader();r.onload=ev=>{const av=ev.target.result;users[cu.email].av=av;cu.av=av;sv('users',users);updTopAv();renderMypage();toast('ğŸ“· ã‚¢ã‚¤ã‚³ãƒ³æ›´æ–°ã—ã¾ã—ãŸï¼');};r.readAsDataURL(f);
}
function saveProf(){
  const nm=document.getElementById('eNm').value.trim();const uid=document.getElementById('eUid').value.trim();
  if(!nm||!uid)return toast('å…¥åŠ›ã—ã¦ãã ã•ã„');
  if(Object.entries(users).some(([em,u])=>u.uid===uid&&em!==cu.email))return toast('ã“ã®IDã¯ã™ã§ã«ä½¿ã‚ã‚Œã¦ã„ã¾ã™');
  users[cu.email].name=nm;users[cu.email].uid=uid;cu={email:cu.email,...users[cu.email]};sv('users',users);updTopAv();renderMypage();toast('âœ… æ›´æ–°ã—ã¾ã—ãŸï¼');
}
function viewMine(){const m=posts.filter(p=>p.uid===cu.uid);srch='';setFeedMode('grid');document.getElementById('gridList').innerHTML=m.map(p=>{const th=p.photos?.[0]?`<img src="${p.photos[0]}">`:`<div class="grid-placeholder ${p.clr}">${catE[p.cat]||'ğŸ“'}</div>`;return`<div class="grid-card" onclick="openDetail('${p.id}')">${th}<div class="grid-card-ov"><div class="gc-title">${p.title}</div><div class="gc-likes">â¤ï¸${fn(p.likes)}</div></div></div>`;}).join('');switchSc('feed');}
function viewLiked(){const m=posts.filter(p=>(p.likedBy||[]).includes(cu.uid));srch='';setFeedMode('grid');document.getElementById('gridList').innerHTML=m.map(p=>{const th=p.photos?.[0]?`<img src="${p.photos[0]}">`:`<div class="grid-placeholder ${p.clr}">${catE[p.cat]||'ğŸ“'}</div>`;return`<div class="grid-card" onclick="openDetail('${p.id}')">${th}<div class="grid-card-ov"><div class="gc-title">${p.title}</div><div class="gc-likes">â¤ï¸${fn(p.likes)}</div></div></div>`;}).join('');switchSc('feed');}

/* â•â• MAP â•â• */
function initMap(){
  const mc=document.getElementById('theMap');mc.style.height=(window.innerHeight-52-50-60)+'px';
  if(!mapInst){mapInst=L.map('theMap').setView([36.2048,138.2529],6);L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'Â© OpenStreetMap',maxZoom:18}).addTo(mapInst);}
  renderMapPins();setTimeout(()=>mapInst.invalidateSize(),200);
}
function setMapTab(el,f){document.querySelectorAll('.maptab').forEach(x=>x.classList.remove('on'));el.classList.add('on');mapFilter=f;if(mapInst)renderMapPins();}
function renderMapPins(){
  mapMkrs.forEach(m=>m.remove());mapMkrs=[];
  let list=posts.filter(p=>p.lat&&p.lng);
  if(mapFilter==='saved')list=list.filter(p=>cu&&(p.savedBy||[]).includes(cu.uid));
  const svIds=cu?posts.filter(p=>(p.savedBy||[]).includes(cu.uid)).map(p=>p.id):[];
  list.forEach(p=>{
    const isSv=svIds.includes(p.id);
    const icon=L.divIcon({className:'',html:`<div style="background:${isSv?'#ffd060':'#a78bff'};color:#fff;padding:5px 10px;border-radius:20px;font-size:0.7rem;font-weight:700;white-space:nowrap;box-shadow:0 3px 12px rgba(0,0,0,0.5);border:2px solid rgba(255,255,255,0.3);">${isSv?'ğŸ”– ':''}${p.title}</div>`,iconAnchor:[0,0]});
    const mk=L.marker([p.lat,p.lng],{icon}).addTo(mapInst).bindPopup(`<div><b>${p.title}</b><br><span style="font-size:0.75rem;color:#aaa;">${p.pref} Â· ${p.cat}</span><br><span style="font-size:0.75rem;">â­${p.rating}/5 Â· â¤ï¸${p.likes}</span><br><br><button onclick="closeOv('mapModal');openDetail('${p.id}')" style="background:linear-gradient(135deg,#a78bff,#ff5f8f);color:#fff;border:none;border-radius:8px;padding:5px 12px;font-size:0.73rem;font-weight:700;cursor:pointer;width:100%;">è©³ç´°ã‚’è¦‹ã‚‹ â†’</button></div>`);
    mapMkrs.push(mk);
  });
}

/* â•â• OV / SHEET â•â• */
function closeOv(id){document.getElementById(id).classList.remove('on');}
['postOv','musicOv','detailOv','profOv'].forEach(id=>{
  const el=document.getElementById(id);
  if(el)el.addEventListener('click',function(e){if(e.target===this)closeOv(id);});
});

/* â•â• SEED â•â• */
function seedPosts(){return[
  {id:'ps1',photos:null,orient:'portrait',music:{id:'m12',title:'Coastal Highway',artist:'Sunset Vibes',emoji:'ğŸŒ…'},title:'è‰åƒé‡Œãƒ¶æµœ',pref:'ç†Šæœ¬çœŒ',cat:'è‡ªç„¶',year:2024,month:5,time:'åˆå‰',crowd:'ç©ºã„ã¦ã„ãŸ',rating:5,desc:'é˜¿è˜‡å±±ã®åºƒå¤§ãªè‰åŸã«é’ã„æ¹–ãŒåºƒãŒã‚‹çµ¶æ™¯ã‚¹ãƒãƒƒãƒˆã€‚æœæ—©ãè¡Œã£ãŸã‚‰èª°ã‚‚ã„ãªãã¦æœ€é«˜ï¼é¦¬ã‚‚æ”¾ç‰§ã•ã‚Œã¦ã„ã¦å†™çœŸæ˜ ãˆãŒåŠç«¯ãªã„ã€‚é§è»Šå ´ã‹ã‚‰å¾’æ­©5åˆ†ã§çµ¶æ™¯ãŒåºƒãŒã‚Šã¾ã™ã€‚',tags:['è‰åƒé‡Œ','ã‚¤ãƒ³ã‚¹ã‚¿æ˜ ãˆ','è‡ªç„¶','çµ¶æ™¯','é˜¿è˜‡','ç†Šæœ¬'],uid:'aso_tabi',uName:'é˜¿è˜‡ãŸã³',uAv:null,badges:{local:true,hidden:false,photo:true},likes:847,likedBy:[],savedBy:[],comments:[{id:'c1',uid:'k_girl',uName:'ç†Šæœ¬ã‚¬ãƒ¼ãƒ«',text:'å…ˆæœˆè¡Œãã¾ã—ãŸï¼æœ€é«˜ã§ã—ãŸã‚ˆã­ğŸ´',time:'3æ™‚é–“å‰'},{id:'c2',uid:'drive_jp',uName:'ãƒ‰ãƒ©ã‚¤ãƒ–æ—¥æœ¬',text:'æ—©æœãŒãŠã™ã™ã‚ã€éœ§ãŒå‡ºã¦å¹»æƒ³çš„ï¼',time:'1æ—¥å‰'}],clr:'pm1',createdAt:Date.now()-86400000*2,lat:32.8873,lng:131.0826},
  {id:'ps2',photos:null,orient:'portrait',music:{id:'m2',title:'Tokyo Drive',artist:'Night City FM',emoji:'ğŸš—'},title:'ç­‰ã€…åŠ›æ¸“è°·',pref:'æ±äº¬éƒ½',cat:'è‡ªç„¶',year:2024,month:9,time:'åˆå‰',crowd:'ç©ºã„ã¦ã„ãŸ',rating:5,desc:'æ±äº¬23åŒºå†…ã«ã‚ã‚‹å”¯ä¸€ã®æ¸“è°·ï¼éƒ½ä¼šã®ã©çœŸã‚“ä¸­ãªã®ã«è‡ªç„¶ãŸã£ã·ã‚Šã§åˆ¥ä¸–ç•Œã¿ãŸã„ã€‚å·æ²¿ã„ã®æ•£ç­–ã‚³ãƒ¼ã‚¹ãŒæœ€é«˜ã§ã€ç„¡æ–™ã§å…¥ã‚Œã‚‹ã®ãŒå¬‰ã—ã„ï¼ç´…è‘‰ã®æ™‚æœŸã¯ç‰¹ã«ãŠã™ã™ã‚ã€‚',tags:['ç­‰ã€…åŠ›æ¸“è°·','æ±äº¬','è‡ªç„¶','ç©´å ´','ç„¡æ–™'],uid:'tokyo_hidden',uName:'æ±äº¬ç©´å ´æ¢ã—',uAv:null,badges:{local:true,hidden:true,photo:false},likes:1203,likedBy:[],savedBy:[],comments:[],clr:'pm3',createdAt:Date.now()-86400000,lat:35.6178,lng:139.6577},
  {id:'ps3',photos:null,orient:'portrait',music:{id:'m11',title:'æ¸‹è°·ã®å¤œ',artist:'Urban Nights',emoji:'ğŸ¸'},title:'èŒ¶äº­ç¾½ç•¶ï¼ˆæ¸‹è°·ï¼‰',pref:'æ±äº¬éƒ½',cat:'ã‚«ãƒ•ã‚§',year:2024,month:11,time:'æ˜¼',crowd:'æ™®é€š',rating:5,desc:'æ¸‹è°·é§…ã‹ã‚‰å¾’æ­©5åˆ†ã®æ˜­å’Œãƒ¬ãƒˆãƒ­ãªåå–«èŒ¶ã€‚æ™‚é–“ãŒæ­¢ã¾ã£ãŸã‚ˆã†ãªç©ºé–“ã§ã‚³ãƒ¼ãƒ’ãƒ¼ã‚’å‘³ã‚ãˆã‚‹ã€‚ãƒã‚¹ã‚¿ãƒ¼ãŒæ·¹ã‚Œã¦ãã‚Œã‚‹ä¸€æ¯ãŒçµ¶å“ï¼å¸¸é€£ã•ã‚“ã‚‚å¤šã„ã€‚',tags:['æ¸‹è°·','å–«èŒ¶åº—','ã‚«ãƒ•ã‚§','ãƒ¬ãƒˆãƒ­','æ±äº¬'],uid:'coffee_lover',uName:'ã‚³ãƒ¼ãƒ’ãƒ¼å¥½ã',uAv:null,badges:{local:true,hidden:false,photo:false},likes:654,likedBy:[],savedBy:[],comments:[],clr:'pm2',createdAt:Date.now()-3600000*6,lat:35.6594,lng:139.6993},
  {id:'ps4',photos:null,orient:'portrait',music:{id:'m14',title:'Kawasaki Factory',artist:'Industrial Beats',emoji:'ğŸ­'},title:'å·å´å·¥å ´å¤œæ™¯ã‚¯ãƒ«ãƒ¼ã‚º',pref:'ç¥å¥ˆå·çœŒ',cat:'å¤œæ™¯',year:2024,month:8,time:'å¤œ',crowd:'æ™®é€š',rating:5,desc:'å·å´ã®å·¥å ´å¤œæ™¯ã‚’ã‚¯ãƒ«ãƒ¼ã‚ºèˆ¹ã‹ã‚‰è¦‹ã‚‹ãƒ„ã‚¢ãƒ¼ï¼ã¾ã‚‹ã§SFã®ä¸–ç•Œã¿ãŸã„ã§æ„Ÿå‹•ã—ãŸã€‚ã‚«ãƒƒãƒ—ãƒ«ã«ã‚‚ã‚ã¡ã‚ƒãã¡ã‚ƒãŠã™ã™ã‚ã€‚è¦äºˆç´„ã€ä¸€äºº2800å††ãã‚‰ã„ã€‚',tags:['å·å´','å¤œæ™¯','å·¥å ´å¤œæ™¯','ã‚¯ãƒ«ãƒ¼ã‚º','ç¥å¥ˆå·','ãƒ‡ãƒ¼ãƒˆ'],uid:'night_view',uName:'å¤œæ™¯ãƒãƒ³ã‚¿ãƒ¼',uAv:null,badges:{local:false,hidden:false,photo:true},likes:2104,likedBy:[],savedBy:[],comments:[],clr:'pm8',createdAt:Date.now()-86400000*7,lat:35.5322,lng:139.7033},
  {id:'ps5',photos:null,orient:'portrait',music:null,title:'å·å´å¤§å¸«ï¼ˆå¹³é–“å¯ºï¼‰',pref:'ç¥å¥ˆå·çœŒ',cat:'è¦³å…‰',year:2024,month:1,time:'åˆå‰',crowd:'æ··é›‘ã—ã¦ã„ãŸ',rating:4,desc:'é–¢æ±ä¸‰å¤§å¸«ã®ã²ã¨ã¤ï¼å¹´å§‹ã¯è¶…æ··é›‘ã™ã‚‹ã‘ã©æ™®æ®µã¯ç©ºã„ã¦ã‚‹ã€‚ä¹…å¯¿é¤…ãŒçµ¶å“ã€‚å·å´é§…ã‹ã‚‰é›»è»Šã§10åˆ†ã€‚ãŠåœŸç”£ã«ã‚‚ã´ã£ãŸã‚Šã€‚',tags:['å·å´','ç¥ç¤¾','è¦³å…‰','ã‚°ãƒ«ãƒ¡','å·å´å¤§å¸«'],uid:'kawasaki_local',uName:'å·å´äºº',uAv:null,badges:{local:true,hidden:false,photo:false},likes:329,likedBy:[],savedBy:[],comments:[],clr:'pm4',createdAt:Date.now()-86400000*5,lat:35.5281,lng:139.7396},
  {id:'ps6',photos:null,orient:'portrait',music:{id:'m7',title:'æ£®ã®æ•£æ­©',artist:'Nature Sounds',emoji:'ğŸŒ¿'},title:'å¥¥å¤šæ‘© é³©ãƒå·£æ¸“è°·',pref:'æ±äº¬éƒ½',cat:'è‡ªç„¶',year:2024,month:10,time:'åˆå‰',crowd:'ç©ºã„ã¦ã„ãŸ',rating:5,desc:'æ±äº¬éƒ½å†…ãªã®ã«æœ¬æ ¼çš„ãªæ¸“è°·ï¼JRé³©ãƒå·£é§…ã‹ã‚‰å¾’æ­©10åˆ†ã§çµ¶æ™¯ã€‚åŠã‚Šæ©‹ã‹ã‚‰ã®ç´…è‘‰ãŒã‚„ã°ã„ã€‚å¾¡å²³æ¸“è°·ã‚ˆã‚Šå…¨ç„¶ç©ºã„ã¦ã¦ãŠã™ã™ã‚ã€‚ç§‹ã¯ç‰¹ã«æœ€é«˜ï¼',tags:['æ±äº¬','è‡ªç„¶','æ¸“è°·','å¥¥å¤šæ‘©','ç´…è‘‰','ç©´å ´'],uid:'tokyo_mountains',uName:'å±±æ­©ãæ±äº¬',uAv:null,badges:{local:false,hidden:true,photo:true},likes:1567,likedBy:[],savedBy:[],comments:[],clr:'pm7',createdAt:Date.now()-86400000*3,lat:35.8214,lng:139.0958},
  {id:'ps7',photos:null,orient:'portrait',music:{id:'m3',title:'å¤ã®å¤•æš®ã‚Œ',artist:'æµ·è¾ºã‚µã‚¦ãƒ³ã‚º',emoji:'ğŸŒŠ'},title:'ç™½å·æ°´æº',pref:'ç†Šæœ¬çœŒ',cat:'çµ¶æ™¯',year:2024,month:7,time:'åˆå‰',crowd:'æ™®é€š',rating:5,desc:'é˜¿è˜‡ã®åœ°ä¸‹æ°´ãŒæ¹§ãå‡ºã‚‹ç¥ç§˜çš„ãªã‚¹ãƒãƒƒãƒˆã€‚é€æ˜åº¦ãŒé«˜ãã¦ã‚ã¡ã‚ƒãã¡ã‚ƒç¶ºéº—ã€‚ãã†ã‚ã‚“æµã—ã‚‚æ¥½ã—ã‚ã‚‹ã€‚å¤ã¯æ°´ãŒå†·ãŸãã¦æœ€é«˜ï¼',tags:['ç†Šæœ¬','çµ¶æ™¯','æ°´æº','ã‚¤ãƒ³ã‚¹ã‚¿æ˜ ãˆ','é˜¿è˜‡'],uid:'aso_tabi',uName:'é˜¿è˜‡ãŸã³',uAv:null,badges:{local:false,hidden:false,photo:true},likes:983,likedBy:[],savedBy:[],comments:[],clr:'pm5',createdAt:Date.now()-86400000*4,lat:32.7972,lng:131.0428},
  {id:'ps8',photos:null,orient:'portrait',music:{id:'m9',title:'è¡—ã®ç¯ã‚Š',artist:'ã‚·ãƒ†ã‚£ãƒãƒƒãƒ—',emoji:'âœ¨'},title:'å·å´ãƒ©ã‚¾ãƒ¼ãƒŠå‘¨è¾ºã‚°ãƒ«ãƒ¡',pref:'ç¥å¥ˆå·çœŒ',cat:'ã‚°ãƒ«ãƒ¡',year:2025,month:2,time:'æ˜¼',crowd:'æ™®é€š',rating:4,desc:'å·å´é§…ç›´çµã®ãƒ©ã‚¾ãƒ¼ãƒŠå‘¨è¾ºã¯ã‚°ãƒ«ãƒ¡ã®å®åº«ã€‚åœ°å…ƒæ°‘ãŠã™ã™ã‚ã®ã¤ã‘éººå±‹ã€éŸ“å›½æ–™ç†ã€ã‚¹ã‚¤ãƒ¼ãƒ„ã¾ã§æƒã£ã¦ã‚‹ã€‚åœŸæ—¥ãƒ©ãƒ³ãƒã¯ä¸¦ã¶ã‘ã©å¾…ã¤ä¾¡å€¤ã‚ã‚Šï¼',tags:['å·å´','ã‚°ãƒ«ãƒ¡','ãƒ©ãƒ³ãƒ','ç¥å¥ˆå·','ãƒ©ã‚¾ãƒ¼ãƒŠ'],uid:'ramen_hunter',uName:'ãƒ©ãƒ¼ãƒ¡ãƒ³æ¢åµ',uAv:null,badges:{local:true,hidden:false,photo:false},likes:541,likedBy:[],savedBy:[],comments:[],clr:'pm6',createdAt:Date.now()-3600000*12,lat:35.5310,lng:139.6983}
];}

/* â•â• UTILS â•â• */
function rLat(p){const m={'æ±äº¬éƒ½':35.68,'ç¥å¥ˆå·çœŒ':35.45,'ç†Šæœ¬çœŒ':32.8,'äº¬éƒ½åºœ':35.0,'å¤§é˜ªåºœ':34.7};return(m[p]||35.0)+Math.random()*0.3-0.15;}
function rLng(p){const m={'æ±äº¬éƒ½':139.7,'ç¥å¥ˆå·çœŒ':139.6,'ç†Šæœ¬çœŒ':131.0,'äº¬éƒ½åºœ':135.7,'å¤§é˜ªåºœ':135.5};return(m[p]||136.0)+Math.random()*0.4-0.2;}
function ce(c){return c?.includes('ç©º')?'ğŸŸ¢':c?.includes('æ··')?'ğŸ”´':'ğŸŸ¡';}
function fn(n){return n>=1000?(n/1000).toFixed(1)+'k':n||0;}
// âœ… catãŒã€Œæ–‡å­—åˆ—ã€ã§ã‚‚ã€Œé…åˆ—ã€ã§ã‚‚æ‰±ãˆã‚‹ã‚ˆã†ã«ã™ã‚‹
function catMain(cat){
  return Array.isArray(cat) ? (cat[0] || '') : (cat || '');
}
function catText(cat){
  return Array.isArray(cat) ? cat.filter(Boolean).join(' / ') : (cat || '');
}
/* âœ… ã“ã“ã«è¿½åŠ ï¼ˆprefæ­£è¦åŒ–ï¼‰ */
function normPref(pref){
  const p=(pref||'').trim();
  const map={
    'æ±äº¬':'æ±äº¬éƒ½','æ±äº¬éƒ½':'æ±äº¬éƒ½',
    'ç¥å¥ˆå·':'ç¥å¥ˆå·çœŒ','ç¥å¥ˆå·çœŒ':'ç¥å¥ˆå·çœŒ',
    'ç¦å²¡':'ç¦å²¡çœŒ','ç¦å²¡çœŒ':'ç¦å²¡çœŒ',
    'ä½è³€':'ä½è³€çœŒ','ä½è³€çœŒ':'ä½è³€çœŒ',
    'é•·å´':'é•·å´çœŒ','é•·å´çœŒ':'é•·å´çœŒ',
    'ç†Šæœ¬':'ç†Šæœ¬çœŒ','ç†Šæœ¬çœŒ':'ç†Šæœ¬çœŒ',
    'å¤§åˆ†':'å¤§åˆ†çœŒ','å¤§åˆ†çœŒ':'å¤§åˆ†çœŒ',
    'å®®å´':'å®®å´çœŒ','å®®å´çœŒ':'å®®å´çœŒ',
    'é¹¿å…å³¶':'é¹¿å…å³¶çœŒ','é¹¿å…å³¶çœŒ':'é¹¿å…å³¶çœŒ',
  };
  return map[p] || p;
}

function sc(s){let h=0;for(const c of(s||''))h=c.charCodeAt(0)+((h<<5)-h);return`hsl(${Math.abs(h)%360},55%,36%)`;}
let toastT;
function toast(m){const t=document.getElementById('toast');t.textContent=m;t.classList.add('on');clearTimeout(toastT);toastT=setTimeout(()=>t.classList.remove('on'),2500);}
  function refreshSpoty(){
  switchSc('feed');     // ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹
  renderVert();         // æŠ•ç¨¿ã‚’æ›´æ–°
  renderGrid();
  renderMypage();
  toast('ğŸ”„ æ›´æ–°ã—ã¾ã—ãŸ');
}
</script>

<script>
  // Spotyèµ·å‹•
  init();
  setFeedMode('vert');
</script>
</body>
</html>



















